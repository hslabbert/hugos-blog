<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.16" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <title>Hugo&#39;s Blog</title>
  

  
  <link rel="stylesheet" href="https://bamboo.slabnet.com/~hslabbert/blog/css/poole.css">
  <link rel="stylesheet" href="https://bamboo.slabnet.com/~hslabbert/blog/css/syntax.css">
  <link rel="stylesheet" href="https://bamboo.slabnet.com/~hslabbert/blog/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://bamboo.slabnet.com/~hslabbert/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://bamboo.slabnet.com/~hslabbert/blog/favicon.png">

  
  <link href="https://bamboo.slabnet.com/~hslabbert/blog/index.xml" rel="alternate" type="application/rss+xml" title="Hugo&#39;s Blog" />
</head>

<body class=" ">

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/"><h1>Hugo&#39;s Blog</h1></a>
      <p class="lead">
       Mostly tech...mostly 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="https://bamboo.slabnet.com/~hslabbert/blog/">Home</a> </li>
      
        <li><a href="https://bamboo.slabnet.com/~hslabbert/blog/"> Home </a></li>
      
        <li><a href="https://bamboo.slabnet.com/~hslabbert/blog/post/"> Posts </a></li>
      
        <li><a href="https://bamboo.slabnet.com/~hslabbert/blog/categories"> Categories </a></li>
      
        <li><a href="https://bamboo.slabnet.com/~hslabbert/blog/about/"> About </a></li>
      
        <li><a href="https://bamboo.slabnet.com/~hslabbert/blog/disclaimer"> Disclaimer </a></li>
      
    </ul>

    <p>&copy; 2016. All rights reserved. </p>
  </div>
</div>


    <div class="content container">
<div class="posts">

      
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/moving-to-hugo/">
        Moving to Hugo
      </a>
    </h1>

    <span class="post-date">Sun, Aug 28, 2016</span>

    <p>So&hellip;I&rsquo;ve moved my blog to Hugo.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/btc-tips/">
        BTC tips
      </a>
    </h1>

    <span class="post-date">Sun, Jan 17, 2016</span>

    <p>This blog hasn&rsquo;t been updated in a bit, but I&rsquo;m experimenting with bitcoin tips.  If you like an article or found it useful, please feel free to send me &ldquo;thank you&rdquo; tip via bitcoin through the BTC address at the bottom of the article.  This is also a rudimentary &ldquo;voting system&rdquo; to let me know which content has been most beneficial to people.</p>

<p>I&rsquo;ll be adding BTC tip addresses to articles in fits and starts for existing articles as I get to them.</p>

<p>Cheers!</p>

<p>JaS</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/what-do-you-run-on-xenserver/">
        What do you run on XenServer?
      </a>
    </h1>

    <span class="post-date">Wed, Jul 14, 2010</span>

    <p><a href="http://twitter.com/XenServerArmy">@XenServerArmy</a> asked in <a href="http://twitter.com/XenServerArmy/status/18477320394">this tweet</a> what applications/services people are running on their XenServer deployments. So, here&rsquo;s a quick list for <a href="http://www.i-worx.ca/">i-worx</a>:</p>

<ol>
<li>Server OS&rsquo;s:

<ol>
<li>Windows Server 2003 R2 (32- and 64-bit)</li>
<li>Windows Server 2008 R2 (64-bit only)</li>
<li>Debian (4.0 &amp; 5.0)</li>
</ol></li>
<li>Active Directory Domain Controllers</li>
<li>MS DNS Servers</li>
<li>Server 2003 32-bit Print Server</li>
<li>MS SQL Servers, 32- and 64-bit (mostly SQL2005, but one old legacy SQL2000 box)</li>
<li>IIS6.0 web servers</li>
<li>MS Exchange 2007 (Hub Transport, Mailbox/Public Folder, and Client Access servers)</li>
<li>Blackberry Enterprise Servers</li>
<li>MS Project 2007</li>
<li>MS Sharepoint Services</li>
<li>MS CRM</li>
<li>Citrix gear

<ol>
<li>Licensing Server</li>
<li>Secure Gateways</li>
<li>Web Interfaces</li>
<li>Desktop Delivery Controllers for XenDesktop farm</li>
<li>Provisioning Servers</li>
<li>XP Virtual Desktops</li>
<li>Server 2008R2 XenApp servers</li>
</ol></li>
<li>NetApp Data Fabric Manager</li>
<li>Sonicwall Viewpoint reporting server</li>
<li>Various ERP, CRM, and document management application servers</li>
<li>Custom, SpamAssassin-based email filtering system</li>
<li>ldirectord load balancers</li>
<li>Vyatta virtual routers</li>
</ol>

<p>So, what are you running on XenServer? :)</p>

<p>Bitcoin tip address for this post:
<a href="bitcoin:1HoAGU848JyFFaJjr7jGsekfr91BZ2Bw9a">1HoAGU848JyFFaJjr7jGsekfr91BZ2Bw9a</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/gone-google-marketing-fail/">
        &#34;Gone Google&#34; Marketing Fail...
      </a>
    </h1>

    <span class="post-date">Tue, Jun 1, 2010</span>

    <p>Google is touting their Google Apps offering for business with a new post on the official Google Blog (<a href="http://googleblog.blogspot.com/2010/06/take-test-drive-into-cloud.html">link</a>). The post presents a link to a gonegoogle.com site, which runs you through a calculator of how much cash you can save by &ldquo;Going Google&rdquo;. The calculator seems to be based on industry averages for things like uptime, storage costs, remote access, etc., and presents a nice little summary poster at the end. An example is given from guest poster smartfurniture.com.</p>

<p>A nice little surprise comes up, though, when you click on the link to view the sample poster for Smart Furniture.</p>

<!-- more -->

<p>Bandwidth fail:</p>

<p><a href="http://justanothersysadmin.files.wordpress.com/2010/06/docs-bandwidth-fail.png"><img src="http://justanothersysadmin.files.wordpress.com/2010/06/docs-bandwidth-fail.png" alt="" /></a></p>

<p>Hmm&hellip;that&rsquo;s not good. And if we try to click <strong>Download</strong>?</p>

<p><a href="http://justanothersysadmin.files.wordpress.com/2010/06/docs-fail-virus-scan.png"><img src="http://justanothersysadmin.files.wordpress.com/2010/06/docs-fail-virus-scan.png" alt="" /></a></p>

<p>Not so good either&hellip;but wait! There is hope! Let&rsquo;s try to <strong>Download anyway</strong>:</p>

<p><a href="http://justanothersysadmin.files.wordpress.com/2010/06/docs-fail-forbidden.png"><img src="http://justanothersysadmin.files.wordpress.com/2010/06/docs-fail-forbidden.png" alt="" /></a></p>

<p>Oh&hellip;damn&hellip;</p>

<p>I&rsquo;ve had a few different people check out the links from different networks and using different Google accounts, and all of them had the same result. With that being said, maybe we all downloaded too much docs content recently (?)</p>

<p>Now, don&rsquo;t get me wrong: I use a lot of Google products and services (Gmail; Docs; Android (HTC Magic running CyanogenMod 5.0.7DS); Chrome, as can be seen in the screenshots; etc.) and love them. This was just too funny to pass up! So, are you ready to Go Google? :)</p>

<p>UPDATE1: Google has changed the poster link to point to a dummy document (<a href="https://docs.google.com/fileview?id=0B2Rsgoiin0I9NjAxYzM3YzAtMjExOC00ZDg1LTkxYWMtYmI1M2RmMzU5ZTYy&amp;hl=en">link</a>) for <em>Acme Inc</em>. Nice one!</p>

<p>Just in case you were curious, the previous sample poster for Smart Furniture is still available (<a href="http://docs.google.com/fileview?id=0B2Rsgoiin0I9NmFmNTIwOWEtNjdhMy00YWI2LWJmNmUtNDNlOGRkODcyNDBl&amp;hl=en">link</a>). My guess is that, as per the initial warning page, posting the PDF for Smart Furniture resulting in them tripping over a bandwidth limit for non-Google format docs for the Smart Furniture Google Apps account. Google probably reset the counter for Smart Furniture, since the original sample doc from them is now accessible, and then generated the dummy Acme Inc. sample page, hosting it within a Google Docs account that is not under the same bandwidth restrictions (internal account?).</p>

<p>So, I guess this has become a &ldquo;nothing to see here, move along!&rdquo; post at this point, but the screenshots still tell the tale of a nice &ldquo;oops!&rdquo; on this campaign. If you share out a Google doc publicly, apparently you won&rsquo;t want it to become too popular lest you hit your cap.</p>

<p>UPDATE2: The links may have been updated to the Acme Inc. dummy company, but the images and text in the post still reference Smart Furniture. I&rsquo;m just nitpicking at this point, though, since the numbers they plugged in for Acme Inc. match those from Smart Furniture; I guess I just like being a little pain in the ass ;)</p>

<p>UPDATE3: K, so they have it all set now. The docs in the sample paragraph just below the video link to the Acme Inc. docs, but Smart Furniture image does now link to an actual Smart Furniture poster. Interestingly, the initial link for the Smart Furniture poster was HTTP, whereas the new link is to same item but over HTTPS, which may indicate differences in bandwidth restrictions between SSL&rsquo;d and non-SSL traffic for Google Docs, or it could just be fluke. Anyhow: Well done to Google for this wrapped up pretty quickly.</p>

<p>Bitcoin tip address for this post: 12xP41mYLfNkwbGZPiMNJ2CSmULcNqeTxb</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/wordpress-theme-updated/">
        Wordpress Theme Updated
      </a>
    </h1>

    <span class="post-date">Thu, Apr 15, 2010</span>

    <p>In case it isn&rsquo;t obvious: I switched up the theme for the site. I was never really too fond of the light-green touch of the previous theme and the code styling especially bugged me, but it was a fairly clean and so I just kind of stuck with it.</p>

<p>Anyhow; comments &amp; feedback appreciated.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/cannot-install-eset-security-on-debian-40-etch-virtuozzo-vps/">
        Cannot install ESET Security on Debian 4.0 Etch Virtuozzo VPS
      </a>
    </h1>

    <span class="post-date">Wed, Feb 11, 2009</span>

    <p>As part of some mail filter testing, I needed to install ESET Mail Security onto a Debian 4.0 Etch VPS running on Virtuozzo. As a side-note, I found that the install package for ESET’s Gateway Filter, Mail Security, and File Server Security for Linux is all the exact same package; the functionality is basically just controlled/activated by means of licensing the appropriate component.</p>

<p>Anyway, the download comes as an installation script called <code>esets.i386.deb.bin</code>. Running that script outputs a license agreement that you have to accept, produces a .deb package called <code>esets.i386.deb</code>, and outputs instructions on how to install the .deb package by using dpkg and import the license file. The .deb package installed just fine on another Debian test box, but when I attempted to run <code>dpkg –i esets.i386.deb</code> on the Virtuozzo VPS, tar squawked at me that it could not open <code>/dev/stdin</code> and the installation bailed:</p>

<pre><code>hostname:/usr/local/src/eset# dpkg -i esets-3.0.11.i386.deb
Selecting previously deselected package esets.
(Reading database ... 24639 files and directories currently installed.)
Unpacking esets (from esets-3.0.11.i386.deb) ...
Setting up esets (3.0.11) ...
Unpacking esets modules ...
tar: /dev/stdin: Cannot open: No such file or directory
tar: Error is not recoverable: exiting now
dpkg: error processing esets (--install):
subprocess post-installation script returned error exit status 2
Errors were encountered while processing:
esets
</code></pre>

<!-- more -->

<p>To which I replied, “huh?”</p>

<p>I took a peek around /dev (<code>ls /dev</code>), and wouldn’t you know it? No stdin, no stdout, and no stderr! Say what? I checked around ESET’s KB’s, but found nothing related to the issue. I poked around Virtuozzo’s and OpenVZ’s wiki’s, but again came up empty. I checked out the /dev directory (<code>ls –l /dev/</code>) on my test box on which I had successfully installed the package, and, as expected, /dev/stdin, /dev/stdout, and /dev/stderr were there. Looking more closely, we see that those files are links to a set of files at /proc/self/fd.</p>

<pre><code>hostname:~# ls -l /dev/std*
lrwxrwxrwx 1 root root 15 2009-01-28 02:35 /dev/stderr -&gt; /proc/self/fd/2
lrwxrwxrwx 1 root root 15 2009-01-28 02:35 /dev/stdin -&gt; /proc/self/fd/0
lrwxrwxrwx 1 root root 15 2009-01-28 02:35 /dev/stdout -&gt; /proc/self/fd/1
hostname:~# 
</code></pre>

<p>So, on my Debian Virtuozzo VPS, I did the following:</p>

<pre><code>ln -s /proc/self/fd/0 /dev/stdin
ln -s /proc/self/fd/1 /dev/stdout
ln -s /proc/self/fd/2 /dev/stderr 
</code></pre>

<p>I re-ran the package installation, and we were set! I don’t know if this issue is particular to some .deb packages or to all, as I had only used <code>apt-get</code> up to that point for package installation. As of now, though, I have not yet had any issues with the package or with the links I created…at least not as far as I can tell!</p>

<p>Let me know if you have any other info on this issue.</p>

<p>Bitcoin tip address for this post:
<a href="bitcoin:1PncfTJjuzybqSDcZrP8qJSApHgtZp5B7F">1PncfTJjuzybqSDcZrP8qJSApHgtZp5B7F</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/550-447-queueexpired-message-expired-when-emailing-mail-enabled-public-folder/">
        “550 4.4.7 QUEUE.Expired; message expired” when emailing mail-enabled Public folder
      </a>
    </h1>

    <span class="post-date">Wed, Feb 11, 2009</span>

    <p>We’ve been working on some major upgrades to our Exchange environment over the last while. During the course of that, we started receiving NDR’s for messages sent to mail-enabled public folders. Initially, these were “MapiExceptionNotAuthorized” messages, which are related to permissions. Those were sorted out without too much trouble, as the NDR is at least somewhat descriptive. But then we started receiving a very generic NDR of <code>#550 4.4.7 QUEUE.Expired; message expired ##</code>.</p>

<p>&hellip;not really much to go on. Exchange 2007 does give some more “in plain English, please!” information in its NDR’s, but that also wasn’t much help:</p>

<p><strong><code>Delivery has failed to these recipients or distribution lists:</code></strong></p>

<pre><code>[user display name]
Microsoft Exchange has been trying to deliver this message without success
and has stopped trying. Please try sending this message again, or provide
the following diagnostic text to your system administrator.
</code></pre>

<p>Wow&hellip;that was helpful&hellip;</p>

<p>After <em>much</em> digging, I found that the problem stemmed from a public folders server that had been retired. It was going to be re-purposed as an SCR target server, but for now was offline. The trouble was that for the Public Folder tree to which the mail-enabled folder belonged was “owned” by this offline server. This “ownership” is found in the <code>msExchOwningPFTreeBL</code>attribute of the public folder store in question. This property is accessible through ADSIEDIT. Now, MS articles to do with this state that the <code>msExchOwningPFTreeBL</code> attribute is not directly editable, but you <em>can</em> edit or remove the <code>msExchOwningPFTree</code> attribute, which effectively updates the <code>msExchOwningPFTreeBL</code> attribute (ref <a href="http://technet.microsoft.com/en-us/library/aa996228.aspx">Public Folder Routing</a> - Technet). I can’t remember if that’s accurate or not, as this happened some time ago, but at this point I only see the <code>msExchOwningPFTreeBL</code> attribute on our PF store, and not the <code>msExchOwningPFTree</code> attribute.</p>

<p>For reference, these attributes are on your PF store, which should be located in the Configuration container in ADSIEDIT (<code>CN=Configuration,DC=yourdomain,DC=[yourtld]</code>). The full path is:</p>

<pre><code>CN=Public Folders,CN=Folder Hierarchies,CN=[Your Exchange Administrative Group Name],CN=Administrative Groups,CN=[Your Exchange Organization Name],CN=Microsoft Exchange,CN=Services,CN=Configuration,DC=[yourdomain],DC=[yourtld].
</code></pre>

<p>After updating the <strong>msExchOwningPFTree</strong> attribute appropriately to a public folders server that was in production resolved the issue.</p>

<p>Bitcoin tip address for this post:
<a href="bitcoin:16KvZ8hMCNTBhhz9KGZ7MKeW3N1WayaYxR">16KvZ8hMCNTBhhz9KGZ7MKeW3N1WayaYxR</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/workaround-for-mysqldump-ssl-error-2026-bug-27669/">
        Workaround for mysqldump SSL error 2026 bug #27669
      </a>
    </h1>

    <span class="post-date">Mon, Feb 9, 2009</span>

    <p>I had not previously played aroung much with MySQL replication, but got the chance to do so recently. I&rsquo;m doing some testing with a new mail filter setup composed of <a href="http://www.ijs.si/software/amavisd/">amavisd-new</a>, <a href="http://spamassassin.apache.org/">SpamAssassin</a>, and some other SA modules running through <a href="http://www.postfix.org/">Postfix</a> on <a href="http://www.debian.org/">Debian</a> Etch. The setup uses <a href="http://www.maiamailguard.com/">Maia Mailguard</a> as a web front-end and management system, including per-user settings and quarantines. We&rsquo;re using MySQL for the database backend for Maia for storing quarantines, per-user settings and the like, but wanted to have a dual-MX setup with a secondary MX sitting in a remote site.</p>

<p><!-- more -->So, we needed some way to keep the MySQL data between the two servers in sync. I had looked at <a href="http://www.drbd.org/">DRBD</a> and <a href="http://www.linux-ha.org/">linux-ha</a>, but in the end decided to go with a dual-master <a href="http://dev.mysql.com/doc/refman/5.0/en/replication.html">MySQL replication</a> setup (<a href="http://www.neocodesoftware.com/replication/">howto1</a>, <a href="http://lug.wsu.edu/node/545/print">howto2</a>), using the built-in SSL capabilities in MySQL to encrypt the replication traffic over the WAN. After a bit of tweaking, I got that going, but then noticed that I could no longer perform mysqldump commands on the databases when running the command locally. I got the following error message whenever I tried a mysqldump command:</p>

<p><code>Got error: 2026: SSL connection error when trying to connect</code></p>

<p>I wasn&rsquo;t specifying any SSL parameters in the mysqldump command, though, and while I did configure the replication users to require SSL in their user setup, the mysqldump user did not have an SSL requirement. I got to the official MySQL bug report for this error(#<a href="http://bugs.mysql.com/bug.php?id=27669">27669</a>) as well as the patch link. But to be honest, that didn&rsquo;t really get me anywhere. The bug report indicates that this behaviour has been corrected in MySQL release 5.0.42, and I was running release 5.0.32.</p>

<p>I updated the mysql-client package on a test machine to 5.0.75 and tried the mysqldump again; the same error still occurred. I didn&rsquo;t want to upgrade the actual mysql-server package as well, so I looked elsewhere for a fix. It occurred to me that, in order for the MySQL replication to use SSL, I had specified the SSL-related options (ssl-ca and so forth) in the [client] section of the global configuration file at /etc/mysql/my.cnf. As mysqldump starts a MySQL client connection, it would stand to reason that it uses the [client] configuration settings that it would find in the global config file, and hence would try to use SSL.</p>

<p>I wanted to get mysqldump to <em>not</em> use SSL connections, but still wanted my replication traffic to use SSL. Since the mysqld daemon runs under the mysql user account, I moved the ssl-related config options out of the [client] section of the global config file of /etc/mysql/my.cnf, created a new .my.cnf config file in the mysql user&rsquo;s $HOME directory (/var/lib/mysql on my system), and entered just the ssl-related options in a [client] section of that .my.cnf file. I reloaded the mysqld daemon and confirmed that the slave connection to the remote server came up properly. It did; the configuration options for the mysql user includes both the global config file of /etc/mysql/my.cnf and the per-user .my.cnf file I had just created, so it is able to pick up the ssl-related options in the [client] section of the per-user settings.</p>

<p>NOTE: The ssl-related options I am talking about here are only those configured in the [client] section. The ssl-related options in the [mysqld] section of the global config file can stay where they are. It should work to have those present in the local mysql user&rsquo;s .my.cnf config file, but I did not test this.</p>

<p>Since no ssl-related options were specified in the global [client] configuration anymore, and no per-user settings were present for the user I was using for the mysqldump command, the command connected without SSL, the SSL error 2026 messages went away, and I was again able to successfully perform MySQL backups from the local machine.</p>

<p>Bitcoin tip address for this post: 15ZhSjpB8iDRHvzgXphpJ9AhkJUPJw5uE5</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/windows-media-player-11-breaks-internet-connectivity/">
        Windows Media Player 11 Breaks Internet Connectivity
      </a>
    </h1>

    <span class="post-date">Wed, Aug 13, 2008</span>

    <p>Alright, so the title for this post seems pretty out there, but I can guarantee you that I have come across this on multiple machines. I&rsquo;m not saying &ldquo;If you install Windows Media Player 11 on your computer, networking will break,&rdquo; I&rsquo;m just saying that if you experience the symptoms outlined below and you&rsquo;re stuck, trying uninstalling WM11 and the WM11 codec; you just might get lucky.</p>

<p>So, one of the other techs in the office calls me over: He&rsquo;s been beating his head against a wall with a remote user being unable to get internet connectivity on his Windows XP workstation. The tech has been on this thing for hours, tried just about everything he can think of shy of a workstation rebuild, and he&rsquo;s looking for some team support. I have him throw the ticket my way; I figure that another set of eyes can only be helpful. With a bit of digging, we isolate the symptoms:</p>

<ul>
<li><p>Full connectivity to the local server is available</p></li>

<li><p>Name resolution is still solid</p></li>

<li><p>Pings are working to both local and remote addresses</p></li>

<li><p>Anything higher up the stack than pings only work locally, and bail as soon as you cross a router. This includes file shares, RDP, FTP, HTTP/s, MAPI, and I&rsquo;m guessing anything else higher than layer 4.<!-- more --></p></li>
</ul>

<p>About an hour or so later, I&rsquo;m still not much farther than tech #1. I&rsquo;ve reset the stack (<code>netsh winsock reset</code>) and rebooted, updated/reinstalled the network card drivers&hellip;heck, we even flashed the BIOS on the thing. Nothing&hellip;zip&hellip;nada.</p>

<p>So, I start thinking that maybe some weird malware/adware that&rsquo;s intercepting traffic and messing things up. I head to Add/Remove Programs and start flipping through the titles. Nothing nasty stands out, but I remove the IE toolbars just to be safe as I&rsquo;ve had some personal experience with Yahoo! toolbars causing crashes and other wonderful things in IE. Still no joy&hellip;</p>

<p>I get to the end of the list and see an entry for <strong>Windows Media Player 11 codec</strong>. Now, fortunate for me, I don&rsquo;t play around with WM much, and so I&rsquo;m not sure if this is a legit piece of software or not. What I do remember is a particularly nasty experience I had with some malware hiding in the Add/Remove Programs list as media players. So, out goes the codec. Just for good measure, I toss Windows Media Player 11 after the reboot and then reboot the box again. Why? To be honest, I really don&rsquo;t know&hellip;I was getting pretty low on bright ideas at that point.</p>

<p>And then, magically, internet connectivity is restored. I still don&rsquo;t have an explanation for this, but for some reason, Windows Media Player 11 being installed on that machine (and at least two others so far in my experience!) caused Layer 5+ routed networking to bail. If you have a KB or something that explains this, please let me know, &lsquo;cause that&rsquo;s just messed up!</p>

<p>Anyhow: Happy hunting!</p>

<p>JaS</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/ssl-errors-in-exchange-2003-public-folder-management/">
        SSL Errors in Exchange 2003 Public Folder Management
      </a>
    </h1>

    <span class="post-date">Wed, Aug 13, 2008</span>

    <p>On a recent network audit for a prospective new client, I came across an issue in the Exchange System Manager for their Exchange Server 2003 box. When you tried to browse into any public folder management, ESM presented the following error:</p>

<p>The SSL certificate server name is incorrect.<!-- more --></p>

<p>I checked the certificate, and it was definitely valid with a trusted Root CA. A quick web search pointed me to <a href="http://support.microsoft.com/kb/324345">this</a> Microsoft KB. The gist is that whoever set up the Exchange server had set SSL to be required on the \Exadmin virtual directory in the default site on the server. The solution: Clear SSL for the Exadmin vdir and relaunch ESM.</p>

<p>This one is fairly straightforward and seems to be fairly common, but I thought I would throw it up here all the same as I had not really come across it in recent memory.</p>

<p>Cheers,</p>

<p>JaS</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/accessing-active-directory-in-php-using-adldap/">
        Accessing Active Directory in PHP using ADLDAP
      </a>
    </h1>

    <span class="post-date">Wed, Aug 13, 2008</span>

    <p>Lately, our company has started developing user web portals for our clients. The main goal is to provide a central reference point for common links (webmail, helpdesk, remote assistance links &hellip; ), howto documents, and other files and resources. A secondary goal was to also allow user administrators to perform basic user management through a web interface. This would include things like disabling/creating/unlocking user accounts, resetting passwords, and modifying group memberships for access reasons. Myself and the other admin tasked with setting up this portal are most familiar with PHP, and so we went of looking for the best means of interfacing with Active Directory through PHP. <!-- more --></p>

<p>Now, you can obviously use PHP&rsquo;s built-in LDAP support, provided PHP was built &ndash;with-ldap. If you&rsquo;re doing a lot of calls back and forth though, this can get pretty tedious pretty fast. It can also be quite intimidating to someone who is more of a sysadmin that a full-time developer (myself included!). So, abstracting away some of the complexity would be handy. I&rsquo;m betting there are other systems out there, but for us, <a href="http://adldap.sourceforge.net/">adldap</a> was the answer.</p>

<p>Adldap provides an easy-to-use interface for both querying and modifying Active Directory. This post is not meant to be a complete setup guide, but rather just an overview, so here&rsquo;s the quick summary:</p>

<ul>
<li><p>Runs on Apache or IIS (although the documentation is a little thin on using IIS)</p></li>

<li><p>Might require some configuration in your environment to support secure LDAP queries over SSL</p></li>

<li><p>Incorporates into your PHP pages through a class definition file. Configure the settings in the provided adldap.php file to match your environment, include() it in your php page, initialize an instance of the class (<code>$adldap = new adLDAP();</code>), and you&rsquo;re ready to go.</p></li>

<li><p>Allows you to add custom functions by adding to the class definition file.</p></li>
</ul>

<p>If some of that sounds scary, don&rsquo;t worry: It can sound more intimidating than it really is. If you have some reasonable PHP background, just go and check it out and get your feet wet. Like I said: Both myself and the other project contributor are not full-time developers, but we&rsquo;ve thrown pretty useful AD integration into the portals. Heck, we&rsquo;ve even started incorporating some AJAX on the site (with some help from <a href="http://www.prototypejs.org/">Prototype</a>&hellip;but that&rsquo;s another post&hellip;) to work with adldap and make the thing pretty slick overall!</p>

<p>One thing that was getting at me a little bit was that I couldn&rsquo;t just throw a custom ldap query string into aldap and get the results. Part of the abstraction is that you get a set of functions for querying for specific types of information: user_info(), user_delete(), authenticate(), group_create(), etc, but no raw ldap query function. So I checked out how the thing is put together, and I bastardized some of the existing functions to suit my purposes. If you&rsquo;re familiar with ldap queries, add the following code into your aldap.php class definition file, and you&rsquo;ve got yourself an easy way of performing custom ldap queries:</p>

<p><code>function any_info($filter=NULL,$fields=NULL){
// Written by Hugo Slabbert (JustAnotherSysadmin - http://bamboo.slabnet.com/~hslabbert/blog) from other functions; defaults to root
if (!$this-&gt;_bind){ return (false); }
if ( $filter==NULL ){ $filter=&quot;(&amp;(objectclass=domainDNS)(!(distinguishedname=&quot; . $this-&gt;_base_dn . &quot;)))&quot;; }
if ($fields==NULL){ $fields=array(&quot;name&quot;,&quot;cn&quot;,&quot;displayname&quot;,&quot;dn&quot;); }
$sr=ldap_search($this-&gt;_conn,$this-&gt;_base_dn,$filter,$fields);
$entries = ldap_get_entries($this-&gt;_conn, $sr);</code></p>

<p><code>return ($entries);
}</code></p>

<p>If you do use the code snippet, I just ask that you keep the comments in tact. I don&rsquo;t mind sharing, but I&rsquo;d like a little bit of the credit!</p>

<p>When you use the <code>any_info()</code> function above, it takes two parameters: your ldap query (<code>$filter</code>), and an array of which attributes you wish to return for the objects that match your query (<code>$fields</code>). If you leave the second parameter blank, the default attributes of name, cn (canonical name), display name, and dn (distinguished name) will be returned.</p>

<p>So, go ahead! Try it out! Let me know if it works for you and what doesn&rsquo;t. I do have two final recommendations, though:</p>

<ol>
<li><p>If you run into technical difficulties getting adldap running properly, you&rsquo;re probably better off going through their actual support (forums, documentation, etc.) than posting requests here. I&rsquo;ve used the system, but I&rsquo;m betting you will get way better support from the actual devs!</p></li>

<li><p>Remember that the point of this tool is to enable access to your Active Directory through the a web interface. Secure your web app accordingly! Putting powerful tools on the web is great, but realize that you are doing just that: Putting POWERFUL tools on the web! You are the best judge (hopefully!) of what suits your organization.</p></li>
</ol>

<p>Happy coding!</p>

<p>Bitcoin tip address for this post: 13344S6vTAmrM5De7DermysvN6UE3QDSzb</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/exchange-2007-messages-stuck-in-submission-queue/">
        Exchange 2007: Messages stuck in Submission Queue
      </a>
    </h1>

    <span class="post-date">Wed, Aug 13, 2008</span>

    <p>We recently received reports of message delivery delays in our Exchange organization. We run Exchange 2007, so I checked out the Hub Transport Servers and discovered that messages were piling up in the <strong>Submission</strong> queues on both of the main hub transports. Restarting the Microsoft Exchange Transport service didn&rsquo;t get things going again, so I turned to the Application Log to try to figure out what was going on.<!-- more --></p>

<p>I noticed some errors coming from the source <strong>MSExchange Extensibility</strong>, with an event ID of 1050. They read as follows:</p>

<blockquote>The execution time of agent 'ScanMail Routing Agent' exceeded 300000 (milliseconds) while handling event 'OnSubmittedMessage'. This is an unusual amount of time for an agent to process a single event. However, Transport will continue processing this message.</blockquote>

<p>From the event, you can tell we&rsquo;re using TrendMicro ScanMail as part of our edge protection. It looked like the ScanMail scanning agent was stuck on a message and couldn&rsquo;t proceed. So, off to the services console I go. ScanMail has three services installed on the server, including its Master Service. The other services seemed happy, but the Master service timed out when I attempted to stop it. I checked the service properties and found its related executable file and killed it through Task Manager. The service was then recorded in the Services Console as being stopped, and after starting the service, mail started flowing again on that Hub Transport server. I repeated those steps on the second Hub Transport server, and messages came flooding out from there as well.</p>

<p>I checked that ScanMail was up to date on both servers, and they appeared to be. I checked through Trend Micro&rsquo;s site nonetheless, and found that there appeared to be a related update. The links:</p>

<p>List of updates for ScanMail 8:  <a href="http://www.trendmicro.com/download/product.asp?productid=8">http://www.trendmicro.com/download/product.asp?productid=8</a>
Direct link to the relevant update:  <a href="http://www.trendmicro.com/ftp/products/patches/smex_80_win_en_patch3.exe">ScanMail 8.0 for Microsoft Exchange Patch 3</a>
The README file:  <a href="http://www.trendmicro.com/ftp/documentation/readme/smex_80_win_en_patch3_Readme.TXT">http://www.trendmicro.com/ftp/documentation/readme/smex_80_win_en_patch3_Readme.TXT</a></p>

<p>The relevant portion of the changelog:</p>

<blockquote>21. While ScanMail for Microsoft Exchange 8.0 is running, after a few hours, email messages will start to queue. If user re-starts the ScanMail for Microsoft Exchange services, the application will hang at "Stopping".</blockquote>

<p>I was technically on vacation while this all went down, so I had to hand of the update to someone else to apply, but no one was available for that weekend. The patch was not manually applied on the servers that weekend, but the issue did not return. We&rsquo;ve now been running smoothly for about two weeks.</p>

<p>Hopefully you don&rsquo;t run across the issue, and hopefully this post will be of some help if you do!</p>

<p>Bitcoin tip address for this post: 1HC44rd1NUZUiWDsHNf9Y1KPSxbtW7b5Sw</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/gmail-filesystem-for-windows/">
        Gmail Filesystem for Windows
      </a>
    </h1>

    <span class="post-date">Thu, May 1, 2008</span>

    <p>If you&rsquo;re looking for an easy online storage solution for Windows (and have a gmail account kicking around), check out the <a href="http://www.viksoe.dk/code/gmail.htm">Gmail Drive</a> by  <a href="http://www.viksoe.dk/code/index.htm">bjarke</a>. It&rsquo;s a free shell extension for Windows that basically adds a new drive to your computer. When you try to access the drive through Windows explorer, you are prompted for your gmail login details (you have the option of saving the details to avoid having to login each time you access the drive).</p>

<!-- more -->

<p>File access seems to work similar to how Windows Explorer interacts with FTP folders. A right-click context menu allows you to create a new folder, but not new files as with a regular Windows disk or share. Files and folders you save in the gmail drive show up as messages with the file/folder as an attachment. The author recommends adding a filter to your gmail account that will automatically archive new Gmail Drive messages (they all start with a subject of &ldquo;<em>GMAILFS</em>&rdquo;. I also added set the filter to add a label of <strong>GMAILDRIVE</strong> for easy searching.</p>

<p>6 gigs of free, easy-access online storage? Bring it on!</p>

<p>JaS</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/vista-offline-files-and-smb-opportunistic-locks/">
        Vista Offline Files and SMB Opportunistic Locks
      </a>
    </h1>

    <span class="post-date">Sun, Mar 30, 2008</span>

    <p>One of our techs recently ran across a problem with a new Windows Vista Business laptop trying to synchronize offline files to a Windows Server 2000 file server. Synchronization would start, but the Sync Center in Vista would show failures for every single file that was attempted to be sync&rsquo;d. The error message read something to the extent of &ldquo;<em>The process cannot access the file because it is being used by another process</em>&rdquo;.</p>

<p>We tried the usual: checking permissions on the folders being offline&rsquo;d (I know that&rsquo;s probably not a word, but you get what I mean); deleting his local cache of Offline Files; disabling and then re-enabling Offline Files. But we just kept on banging our heads against the same error. At first, just about any web search for the error resulted in either something about Windows Home Server or databases or something of the like.  Eventually, though, we struck gold:</p>

<p><a href="http://support.microsoft.com/kb/296264/en-us">http://support.microsoft.com/kb/296264/en-us</a>: Configuring opportunistic locking in Windows</p>

<!-- more -->

<p>According to MS, opportunistic locking &ldquo;<em>lets clients lock        files and locally cache information without the risk of another user changing           the file</em>&rdquo;. Opportunistic Locking is a feature of SMB. It is enabled by default, and is configurable from the client side (i.e. request opportunistic locking or not) and on the server side (i.e. allow opportunistic locking on local files or not).</p>

<p>Also note: &ldquo;<em>If you disable opportunistic locking, the offline files feature in Windows           Vista fails</em>&ldquo;</p>

<p>So, apparently, &ldquo;_The process cannot access the file because it is being used by another process&rdquo; <em>actually means</em> &ldquo;Opportunistic locking is not enabled on the file server_&ldquo;. Nice&hellip;</p>

<p>Be aware that this setting is changed through the registry, so the regular warnings about messing about in REGEDIT apply (read <a href="http://bamboo.slabnet.com/~hslabbert/blog/disclaimer/">Disclaimer</a>). That stuff is already listed in the KB, so I won&rsquo;t bother to repeat it.</p>

<p>To enable opportunistic locking on the file server, open REGEDIT to HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters, and change the value of the REG_DWORD
<strong>EnableOplocks</strong> from 0 to 1.</p>

<p>The server does need to be rebooted in order for the registry change to take effect. After rebooting, retry your offline files synchronization. If the opportunistic locking was your problem, you should be good to go!</p>

<p>UPDATE:</p>

<p>I must also thank Rainier Day for <a href="http://blog.rainiernetworks.com/2008/06/25/vista-synchronization-errors/">his post</a> on his struggles with Opportunistic Locking. He was hit from the other side: The server-side opslock settings were good, but his Vista clients were configured to <em>not</em> request opportunistic locks, and this caused the clients to also experience offline files synchronization errors. Thanks Ranier: I noticed that component in the MS KB, but had never actually come across a Vista workstation that was configured out-of-the-box to have OpsLocks disabled!</p>

<p>Cheers,</p>

<p>JaS</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/find-disabled-and-inactive-user-and-computer-accounts-using-powershell-part2/">
        Find Disabled and Inactive User and Computer Accounts using Powershell - Part II
      </a>
    </h1>

    <span class="post-date">Tue, Mar 25, 2008</span>

    <p>Part I demonstrated how to find aged or inactive accounts, and in Part II we will look at another lingering account type: disabled accounts.</p>

<p>Like inactive accounts, Directory Searchers also come in handy for disabled accounts. We can also, however, read an Active Directory account&rsquo;s status directly from a hidden attribute on the ADSI object. Let&rsquo;s start with the Directory Searcher method. This entry also draws from <a href="http://blogs.technet.com/bahramr/archive/2008/01/25/powershell-script-to-disable-inactive-accounts-in-active-directory.aspx">Bahram’s Blog</a>. The code:</p>

<p><code>$adobjroot = [adsi]''
$objdisabsearcher = New-Object System.DirectoryServices.DirectorySearcher($adobjroot)
$objdisabsearcher.filter = &quot;(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=2))&quot;
$resultdisabaccn = $objdisabsearcher.findall() | sort path</code></p>

<!-- more -->

<p>That was a lot easier! The <code>$adobjroot</code> line gives us an ADSI object for the root of our domain. The second line creates a new Directory Services searcher, and then we add our filter.</p>

<p>As with Part I, setting objectCategory to <code>person</code> and objectClass to <code>user</code> sets up our filter to search for user accounts; switch both of those to <code>computer</code> to search for computer accounts instead.</p>

<p>The userAccountControl portion is a bit of weird number, though, isn&rsquo;t it?! After some digging, I was able to determine that the <code>:1.2.840.113556.1.4.803:</code> is the attribute ID for the Last-Logon-Timestamp Attribute (found on an <a href="http://msdn2.microsoft.com/en-us/library/ms676824.aspx">MSDN article</a> linked from <a href="http://blogs.technet.com/bahramr/archive/2008/01/25/powershell-script-to-disable-inactive-accounts-in-active-directory.aspx">Bahram&rsquo;s Blog</a>). Specifying that value in the directory searcher filter queries for the value of that specific attribute stored in the userAccountControl property, rather than userAccountControl as a whole. Stephen Looney actually corrected this for me, as I was somewhat off the mark in my deduction. The string is not a selection filter, as I had supposed, but more akin to a bitwise OR operator. See his comment below for clarification.</p>

<p>The last line of the code simply collects our searcher results in System.DirectoryServices.SearchResult collection</p>

<p>The alternative method to determine an account&rsquo;s status is to check a hidden attribute on the ADSI object itself. For this you will need the Distinguished Name of a user or computer account:</p>

<p><code>$struserdn = &quot;CN=Some User,OU=Users,OU=Corp,DC=yourdomain,DC=com&quot;</code></p>

<p>Set up an ADSI object for that account:</p>

<p><code>$adobjuser = [ADSI]&quot;LDAP://$struserdn&quot;</code></p>

<p>And access the hidden method:</p>

<p><code>$adobjuser.PsBase.InvokeGet(&quot;AccountDisabled&quot;)</code></p>

<p>This will return $true if the account is disabled, and $false if the account is not disabled (i.e. it is enabled). It&rsquo;s not as glamorous as the directory searcher method, but I think both have their place.</p>

<p>Also, feel free to play around with the lastLogonTimeStamp and UserAccountControl attributes in the directory searcher. For instance, to find only disabled accounts that have been inactive for a certain number of days, you could use an LDAP string like:</p>

<p><code>$objsearcher.filter =</code><code>(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=2)</code><code>(lastLogonTimeStamp&lt;=&quot; + $lltIntLimit + &quot;)</code><code>)&quot;</code></p>

<p>Or switch it up for only enabled accounts inactive for a certain period by flipping the userAccountControl portion around be negative:</p>

<p><code>$objsearcher.filter =</code><code>(&amp;(objectCategory=person)(objectClass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2)</code><code>)(lastLogonTimeStamp&lt;=&quot; + $lltIntLimit + &quot;)</code><code>)&quot;</code></p>

<p>I hope this has been helpful. As always, comments, corrections, additions, or questions are appreciated.</p>

<p>Bitcoin tip address for this post: 192yT6362K6BgLpm8B2xhcCVZtrnwQkjek</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/find-disabled-and-inactive-user-and-computer-accounts-using-powershell-part1/">
        Find Disabled and Inactive User and Computer Accounts using Powershell - Part I
      </a>
    </h1>

    <span class="post-date">Tue, Mar 25, 2008</span>

    <p>We&rsquo;ll start off with Inactive accounts first, and then work on the disabled accounts after that.</p>

<p>Active Directory in Server 2003 has a nice user/computer attribute called lastLogonTimeStamp that can help us keep track of inactive accounts. If you have ever tried to use that attribute, however, you might have come up with something like this&hellip;</p>

<!-- more -->

<p><code>PoSH&gt; $struserdn = &quot;CN=Some User,OU=Users,OU=Corp,DC=yourdomain,DC=local&quot;
PoSH&gt; $adobjuser = [ADSI]&quot;LDAP://$struserdn&quot;
PoSH&gt; $adobjuser
{CN=Some User,OU=Users,OU=Corp,DC=yourdomain,DC=local}</code></p>

<p><code>PoSH&gt; $adobjuser.lastLogonTimetamp</code></p>

<p><code>PoSH&gt;</code></p>

<p>What the &hellip;? Hmm&hellip;I&rsquo;m sure I saw lastLogonTimestamp in the members for that object before:</p>

<p><code>PoSH&gt;$adobjuser | Get-Member</code></p>

<p><code>TypeName: System.DirectoryServices.DirectoryEntry
...
lastLogonTimestamp              Property   System.DirectoryServices.PropertyValueCollection lastLogonTimestamp {get;...
...
</code>
<code>PoSH&gt;</code></p>

<p>Right,  like I said! Then why doesn&rsquo;t it give me any information for that property? May it&rsquo;s blank? Highly unlikely, but let&rsquo;s check:</p>

<p><code>PoSH&gt; $adobjuser | Format-List *
...
lastLogonTimestamp              : {System.__ComObject}
...</code></p>

<p><code>PoSH&gt;</code></p>

<p>Great! What do I do with that thing? To be honest, working with ComObjects is not really my thing, but we still can get the information we want. For my purposes, I was searching through AD with a DirectorySearcher anyway, and the answer to my problems came from DirectorySearcher in the end. First, the code (credit to <a href="http://blogs.technet.com/bahramr/archive/2008/01/25/powershell-script-to-disable-inactive-accounts-in-active-directory.aspx">Bahram&rsquo;s Blog</a>), and then we&rsquo;ll run through what we&rsquo;re actually doing.</p>

<p><code>$currentDate = [System.DateTime]::Now
$currentDateUtc = $currentDate.ToUniversalTime()
</code><code>$lltstamplimit = $currentDateUtc.AddDays(- $NumDays)
$lltIntLimit = $lltstampLimit.ToFileTime()
$adobjroot = [adsi]''
</code><code>$objstalesearcher = New-Object System.DirectoryServices.DirectorySearcher($adobjroot)
</code><code>$objstalesearcher.filter = &quot;(&amp;(objectCategory=person)(objectClass=user)(lastLogonTimeStamp&lt;=&quot; + $lltIntLimit + &quot;))&quot;
</code><code>$resultstaleaccn = $objstalesearcher.findall() | sort path</code></p>

<p>Alright, so before we get going, this snippet of code requires that we define an Int32 variable called <code>$numdays</code> before we run it. This will be used as the number of days since the account last logged on. So what exactly is going on here? The easiest way to both get a proper DateTime object and get a relative time for setting the period for inactive accounts is to get the current date and time:</p>

<p><code>$currentDate = [System.DateTime]::Now</code></p>

<p>As far as I can see, you could also use <code>$currentdate = Get-Time</code> , so it&rsquo;s your choice, really.</p>

<p>Active Directory stores times in UTC format, so we can use the ToUniversalTime() method available on the System.DateTime class:</p>

<p><code>$currentDateUtc = $currentDate.ToUniversalTime()</code></p>

<p>This is where the <code>$numdays</code> variable comes in. Let&rsquo;s say your organization has a policy in effect that accounts that have been inactive for 60 must be disabled. If the lastLogonTimeStamp attribute is 60 days less than the current Date/Time, then we know that account has not been logged onto for the last 60 days. So, we will want to search for accounts that have a value 60 days less than today in their lastLogonTimeStamp attribute. To make that reference point, we can do some simple math:</p>

<p><code>$lltstamplimit = $currentDateUtc.AddDays(- $NumDays)</code></p>

<p>This assumes that we have run <code>$NumDays = 60</code> somewhere before this last command, and effectively saves our last logon time stamp limit ($lltstamplimit) as a System.DateTime value 60 days before now.</p>

<p><code>$lltIntLimit = $lltstampLimit.ToFileTime()</code> converts the <code>$lltstamplimit</code> to an Int64 value. Why? You&rsquo;ve got me! Please let me know if you have the goods on this, because I&rsquo;m still blissfully unaware of the purpose/function of Int64 values.</p>

<p>The rest is fairly straight-forward. We set up a directory searcher and define the filter as a user object the lastLogonTimeStamp less than the limit we defined in <code>$lltIntLimit</code>.</p>

<p><code>$adobjroot = [adsi]''
$objstalesearcher = New-Object System.DirectoryServices.DirectorySearcher($adobjroot)
$objstalesearcher.filter = &quot;(&amp;(objectCategory=person)(objectClass=user)(lastLogonTimeStamp&lt;=&quot; + $lltIntLimit + &quot;))&quot;
</code></p>

<p>In the name of tidiness and efficiency, I would recommend restricting the search root to your user containers with something like <code>$objstalesearcher.searchroot = &quot;LDAP://$searchrootdn&quot;</code> where $searchrootdn is a distinguished name as a string.</p>

<p>All that remains at that point is to collect the results:</p>

<p><code>$resultstaleaccn = $objstalesearcher.findall() | sort path</code></p>

<p>For my own purposes I sort the results by their LDAP path, but you obviously don&rsquo;t have to. Remember that your result will be saved as a System.DirectoryServices.SearchResult object, so you will probably have to use <code>$_.Properties.[SomeProperty]</code> to get the information you&rsquo;re looking for.  From there, you can do with the results as you please.</p>

<p>Oh, and if you&rsquo;re looking for inactive computer  accounts instead of user accounts, switch both the objectCategory and objectClass values in your DS searcher filter to <em>computer.</em></p>

<p>To learn how to find <em>disabled</em> accounts rather than inactive ones, head over to Part II.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/bulk-rename-files-with-sequential-index/">
        Bulk Rename Files with Sequential Index
      </a>
    </h1>

    <span class="post-date">Sun, Mar 23, 2008</span>

    <p>I am pretty sure I&rsquo;m not the only one who wants something more descriptive than DSC1900298.JPG to name my digital photos. And yes, I know that Windows Explorer allows you to rename pictures en masse, but I don&rsquo;t like the convention they have chosen in that the first file is named <em>[common name].JPG</em>, then the subsequent files are named <em><a href="2">common name</a>.JPG</em> and so on and so forth.</p>

<p>I had a few requirements for how I wanted to go about this:</p>

<ol>
<li><p>Get rid of the parentheses. If I will be posting those pics online anywhere, I wanted to keep the names as free of special characters as I can.</p></li>

<li><p>Number the first file. The Windows Explorer route does not number the first file when doing bulk renames. This is easy enough to do manually, but I just don&rsquo;t want to bother.</p></li>

<li><p>Keep a constant number of digits in the index number. I want the renaming process to take into account how many pictures there are and adjust the number of index digits accordingly. If there are fewer than 10 files/images, then only 1 digit is required (e.g. 1, 2, 3, 4&hellip;9). If there are between 10 and 99 files (inclusive), then two digits are required (01, 02, 03&hellip;10, 11, 12&hellip;99). I think you get the idea. Windows definitely doesn&rsquo;t do that.</p></li>
</ol>

<p><!-- more -->I thought that Powershell would be the best tool for the job, but I still struggled a bit. I eventually found the following would do the trick:</p>

<p><code>$prefix = &quot;[SomePrefix]&quot;
$files = Get-ChildItem
$id = 1
$files | foreach { Rename-Item -Path $_.fullname</code><code>-NewName</code><code>( $prefix + ((($id++).tostring()).padleft(($files.count.tostring()).length) -replace ' ','0' ) + $_.extension) }</code></p>

<p>Note that everything after the <code>$files |</code>is all on one line of code, but it might appear in the post as being spread across multiple lines.</p>

<p>The Explanation:</p>

<p>The first line saves the contents of the current directory into an array. <code>$id = 1</code> just resets our index counter so that the first file will be numbered 1. Now the fun stuff begins!</p>

<p>We pipe the <code>$files</code> array into a foreach loop to process through each of the files in the directory. The foreach loop just contains the Rename-Item cmdlet. We select the full path of the item passed through the pipeline, <code>$_.fullname</code>, as the original item to rename. The -NewName item gets a bit complicated.</p>

<p>As we will be including a whole bunch of items, we first open with parentheses, &ldquo;(&rdquo;. The new name will start with a string we have to define earlier, <code>$prefix</code>. If, for instance, your collection of pictures in the working directory is from the slick cabling job you just did on one of your racks, you can set <code>$prefix = &quot;SlickCablingJob&quot;</code>. This will result in files named something like <code>SlickCablingJob01.jpg</code>, etc.</p>

<p>The next portion has a few opening parentheses, and this is because we will be performing a bunch of operations on our <code>$id</code> variable, which is our index number. We use <code>$id++</code> because we want to <code>$id</code> variable to increment each time we pass through the foreach loop and use the variable.</p>

<p>To set the number of digits, I used the PadLeft() method. The PadLeft() method basically adds spaces to the left side of whatever string you are processing so that the resultant string is of a length that you specify. If, for instance, I have a string of &ldquo;four&rdquo; saved to the variable <code>$string</code> and used the command $string.PadLeft(10), the resultant string would be &ldquo;four&rdquo; with 6 spaces to its left, for a total of 10 characters in our string.</p>

<p>Unfortunately, PadLeft() is not a method of the Int32 class, of which our <code>$id</code> variable is an instance, but it is a method of the String class. So, we first have to convert the <code>$id</code> variable to a string using <code>$id.ToString()</code>. I like to keep things clean, so I used <code>($id.ToString()).PadLeft()</code> to first wrap up the result of <code>$id.ToString()</code> and then apply the PadLeft() method.</p>

<p>Now, PadLeft() requires an Int32 parameter to tell it how many places to pad to the left of the string. This is where some of the magic comes in. Remember how we saved the list of files in the directory to the array <code>$files</code>? Well, that array has a property <code>Count</code>, which is a count of the number of items in the array, in our case the number of files in the array.</p>

<p>We count the number of items in our directory listing array using <code>$files.Count</code>. Since we want to see how many characters are in the highest number in our file list (which is equal to the number of files in the <code>$files</code> array), we can use the <code>Length</code> property. The <code>Length</code> property, when used on Strings, will return the number of characters in the string as an Int32 value. Using our <code>$string</code> of &ldquo;four&rdquo; from earlier, <code>$string.Length</code> will be equal to and Int32 value of 4, since there are four characters in the string &ldquo;four&rdquo;. If <code>$string</code> were &ldquo;one&rdquo;, <code>$string.Length</code> would be 3, since there are three characters in the string &ldquo;one&rdquo;. This can get confusing, so you might want to try it out with a few different values to get the hang of it.</p>

<p>Let&rsquo;s say that we have 45 files in our directory. <code>$files.Count</code>would be an Int32 value of 45. The length property cannot be applied to Int32 values, so we have to convert our value to a string using <code>$files.Count.ToString()</code>. In our example of 45 files in our directory, <code>$files.Count.ToString()</code> would return a string value of &ldquo;45&rdquo;. The length property of that value would be the Int32 value 2. This is because the string &ldquo;45&rdquo; has two characters in it. If we had between 1 and 9 files (inclusive), the <code>$files.Count.ToString()</code> value would be 1 because there is only one character in the numbers 1, 2, 3, 4, 5, 6, 7, 8, and 9 since they are single-digit numbers. If we had between 10 and 99 files in our list, we would have a double-digit number, and hence <code>$files.Count.ToString()</code> would have a value of 2. Again, you might want to play around with this if you are unfamiliar with the concept.</p>

<p>So far, then, we have <em>(($id++).ToString()).PadLeft(($Files.Count.ToString()).Length</em>, which takes the index number, converts it to a string, and then pads it with spaces to its left so that the total of characters is equal to the number of characters in the count of the number of files in the list. It might be best to demonstrate with another example to bring it all together. Let&rsquo;s say that we have one hundred (100) files that we are renaming, and the foreach loop is working through the first file.</p>

<p>The <code>$id</code> variable is set to the Int32 value of 1. This is converted to a string that reads &ldquo;1&rdquo;. Since we have 100 files in our list, <code>$files.Count</code> will have an Int32 value of 100. In order to count the number of characters in that value, we convert it to a string using <code>$files.Count.ToString()</code>, then count the number of characters using <code>$files.Count.ToString().Length</code>. This gives us an Int32 value of 3, since there are three characters in the number 100. PadLeft() then pads our <code>$id</code> of 1 so that it has three characters in total, as a one with 2 spaces to its left. We&rsquo;re almost there!</p>

<p>The last part of the indexing replaces the spaces from PadLeft() to zeroes, so that the files will show up chronologically in a directory listing. This is done through the <code>-replace ' ','0'</code> part of the line, which replaces spaces with zeroes. For our example, we would no longer have &ldquo; 1&rdquo; but rather &ldquo;001&rdquo; (insert 007 joke here). Finally, my third requirement is met!</p>

<p>All that is left to then append the original file extension to the filename. Since we have the original file in the pipeline, we can access its extension using <code>$_.Extension</code>. And voila! We have our bulk rename tool!</p>

<p>Now, as the code stands, we have to first define our <code>$prefix</code> variable before using it, and it only acts on files in the current working directory. I threw this into a function with a parameter of <code>$prefix</code>, so that I can easily define the prefix and call the function conveniently from within the directory that contains the files I want to rename. You could also specify an additional parameter of <code>$directory</code> to the function to be able to work on directories other than your current working directory, as long as you change <code>$files = Get-ChildItem $directory</code>.</p>

<p>Here is the function as it sits in my current Powershell profile:</p>

<p><code>function Rename-Bulk($prefix)
{
$files = Get-ChildItem
$id = 1
$files | foreach { Rename-Item -Path $_.fullname</code><code>-NewName</code><code>( $prefix + ((($id++).tostring()).padleft(($files.count.tostring()).length) -replace ' ','0' ) + $_.extension) }
}</code></p>

<p>To define the function in your Powershell session, either paste the code above at the Powershell prompt, or paste it into your Powershell profile to have it available each time you start Powershell (be sure to remove any line breaks; remember that everything after <code>$files |</code> is one one line)!</p>

<p>To add the extension I had mentioned to specify a directory other than your current working directory, use the following instead:</p>

<p><code>function Rename-Bulk($prefix,$directory=$pwd)
{
$files = Get-ChildItem $directory
$id = 1
$files | foreach { Rename-Item -Path $_.fullname -NewName ( $prefix + ((($id++).tostring()).padleft(($files.count.tostring()).length) -replace ' ','0' ) + $_.extension) }
}</code></p>

<p>That will select the current working directory by default if the second parameter is not specified, while still giving you the option to specify an alternate directory.</p>

<p>As always, if there is something I&rsquo;ve missed (it&rsquo;s getting late!) or if you have something to add, please let me know.</p>

<p>Bitcoin tip address for this post: 1M4ydWcEPsUXWrQYN254UrfkAbVGBbpZB8</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/take-ownership-of-files-and-folders-through-script/">
        Take ownership of files and folders through script
      </a>
    </h1>

    <span class="post-date">Sun, Mar 23, 2008</span>

    <p>As part of our process to disable user accounts, we take ownership of the user&rsquo;s server-stored documents such as roaming profiles and redirected My Documents directories. We then either keep access restricted to the domain admins group or grant access to a replacement user who should receive access to the departed user&rsquo;s files.</p>

<p>With an upgrade to Exchange 2007, we have taken advantage of the Powershell access to Exchange objects, and have scripted the mailbox provisioning and account disable processes. One of the sticking points in getting the disable script wrapped up was seizing control of the user&rsquo;s directories. Now, Powershell does have the ability to modify ACL&rsquo;s through the New-Acl and Set-Acl cmdlets (links below), but the users have exclusive access to their server-side directories. It is easy enough to take ownership of a directory through the Windows Explorer Security dialog, but the Powershell methods all presented some form of error when trying to set permissions or change ownership on a file system object to which you do not already have access to.</p>

<!-- more -->

<p>I struggled for some time off and on to try to work around this with a native Powershell way of seizing control of a directory, but I simply could not find what I was looking for. Eventually, I fell back to a simple tool built into Server 2003 already: Takeown.exe. Through a simple line, takeown got me the results I wanted. I built an array of strings for the directories I wanted to take ownership of, generally in a UNC path such as \servername\users$[sAMAccountName], then wrapped the takeown line in a Foreach loop:</p>

<p><code>Foreach ( $directory in $directories )
{
takeown.exe /A /R /D Y /F $directory
}</code></p>

<p>To learn more about the options for Takeown, simply type Takeown /? at the command line. For reference:</p>

<ul>
<li><p>/A - Grants ownership to the Administrators group rather than a particular user.</p></li>

<li><p>/R - Recurses</p></li>

<li><p>/D Y - Sets the default to prompts to <em>Yes</em></p></li>

<li><p>/F - The file name of the file system object to take ownership of</p></li>
</ul>

<p>After taking ownership, the regular Powershell native cmdlets can be used to set up permissions as are required. For more information on Powershell ACL tools, check out the following links:</p>

<ul>
<li><p><a href="http://mshforfun.blogspot.com/2005/12/play-with-acl-in-msh.html">Play with ACL in MSH</a></p></li>

<li><p><a href="http://blog.netnerds.net/2007/07/powershell-set-acl-does-not-appear-to-work/">PowerShell: Set-Acl Does Not Appear to Work</a></p></li>

<li><p><a href="http://richardsiddaway.spaces.live.com/Blog/cns!43CFA46A74CF3E96!1069.entry">File system: Allow inheritable permissions from parent to propagate</a></p></li>
</ul>

<p>Bitcoin tip address for this post: 1MBiHN2jptsRRxYMvjypHH94JhQTv2QGyA</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/dell-broadcom-server-2003-sp2-snp-and-toe/">
        Dell, Broadcom, Server 2003 SP2 SNP and TOE
      </a>
    </h1>

    <span class="post-date">Sun, Mar 23, 2008</span>

    <p>Dell, Broadcom, and Microsoft have decided to partner up with the release of a technology called TCP/IP Offloading, or TOE for <em>TCP/IP Offload Engine</em>. It was bundled together in the Scalable Network Pack (SNP), included and enabled by default with Service Pack 2 (SP2) for Windows Server 2003. The gist of this technology is to enable high-load enterprise applications to be easily scalable. For those of you familiar with the OSI model, TOE moves layer 3 and 4 processing out of the OS and CPU into the NIC. The idea is to better utilize advances in network card performance and free up CPU cycles for other purposes, such as application-side processing.</p>

<p>This all seems well and good, if they saw fit to properly test the stuff out against their own applications!</p>

<!-- more -->

<p>It started with a few calls: users would get a <em><strong>Waiting to Update this Folder</strong></em> message in their Outlook client that did not go away even after several hours, but Outlook still showed as <em><strong>Connected to Microsoft Exchange</strong></em>. Except this was not just for a few users; every single user on a particular Exchange 2007 mailbox server would be affected&hellip;not cool when more than 300 mailboxes from multiple different clients are affected!</p>

<p>Restart system attendant on mailbox server? No joy. Restart  WWW and SSL services on Client Access Server? Wrong again. Restart every freakin&rsquo; Exchange service on the mailbox and Client Access Server? Still no positive change. Fine! Get the go-ahead and restart the mailbox server? Bingo.</p>

<p>That,  however, is not what we call a <em>resolution</em>. At best that&rsquo;s a workaround, but a workaround that comes with guaranteed downtime, and no explanation as to the cause. So we checked the event viewers on the mailbox server and the client access servers, and found&hellip;nothing&hellip;damn&hellip; Run the Best Practice Analyzer for Exchange&hellip;nothing useful&hellip;damn again&hellip; Whatever, chalk it up to freaky coincidences and keep going. That was fine, until it happened again, and again, and again, all with no trace.</p>

<p>Alright, so a call to MS Support it is. Four hours on the phone later, and no real answers. The tech suggests that we <a href="http://support.microsoft.com/kb/912222">disable TCP/IP Chimney</a>, one of the features of the TCP/IP Offloading technology, and we comply. As is to be expected, the support guys wanted to try and pin it on an Outlook issue, as that is where the problem was most visible. But that just doesn&rsquo;t fly when every single client on a particular mailbox server is affected at the exact same time. Anyway, they tell us that they will keep checking on it, but that we will have to call them back when the problem is occurring and <em>before</em> we reboot the affected mailbox server. Okay&hellip;well&hellip;tell that to the 300+ users screaming for email access they are paying for!</p>

<p>The next time the problem rolls around, I try to get the okay to call MS, but the clients have already had too many email headaches from this problem, and we&rsquo;re forced to reboot the box again to keep people happy. Fortunately, MS gets a higher-up tech in touch with us, and the guy drills us with some useful questions for relevant information. He starts to run through the BPA stuff again and gets us to export the event logs and upload them for further examination. He requests that we download a specific Exchange troubleshooting tool, and upload the logs for that as well. Now we&rsquo;re getting somewhere! Or so I thought.</p>

<p>The mailbox servers that were affected get through the majority of the tests and information gathering of the tool they had us download, but it bails on some RPC-related diagnostics. I report this to the tech, so he directs us to use a different tool that skips around that part. After some scheduled reboots, the original tool completes its diagnostics, and we can upload the results. At this point, we can&rsquo;t afford more problems, so we&rsquo;re actually running _nightly _reboots on the Exchange mailbox and CAS servers. This seems to stave off the problem, but, again, this is just a workaround.</p>

<p>The tech finds nothing in the event viewer to indicate any problems, but he suggests the TCP/IP Chimney disable thing again. This time, however, we also are told to disable any offloading features in the network card device configuration as well. I find the settings and switch them off. We had consolidated mailboxes so that one of the mailbox servers remains with only a few test mailboxes and the mailboxes of some of our support team members on it. It&rsquo;s a gamble, but we remove nightly reboots from that server and switch back to the regular reboot schedule. Weeks pass, and we don&rsquo;t run into any problems. We load some more mailboxes on there, and still no problems.</p>

<p>So, after weeks and weeks of reliability problems, the sneaky culprit was a set of technologies teamed together as the Scalable Network Pack (SNP), introduced without much notice with SP2 for Server 2003. I ended up writing a VB script that determines if a server is running with Broadcom network cards and disables the TOE settings in the TCP/IP stack directly as well as the TOE and SNP settings on the network cards themselves through some registry edits.</p>

<p>I later found that the MSExchange team had posted a <a href="http://msexchangeteam.com/archive/2007/07/18/446400.aspx">blog entry</a> about potential problems with TOE and Exchange 2007, but had for some reason never come across this post in my searches on the symptoms we were experiencing. I have also since run into posts from other sysadmins reporting that the TOE features cause Internet Security and Acceleration (ISA) Server to lock up completely.</p>

<p>I would post the VB script I created for dealing with this problem, but Microsoft also just released a <a href="http://support.microsoft.com/kb/948496">hotfix</a> that specifically disables the SNP features. Here is a list of some of the problems the hotfix is meant to address:</p>

<ul>
<li><p>When you try to connect to the server by using a VPN connection, you receive the following error message: Error 800: Unable to establish connection.</p></li>

<li><p>You cannot create a Remote Desktop Protocol (RDP) connection to the server.</p></li>

<li><p>You cannot connect to shares on the server from a computer on the local area network.</p></li>

<li><p>You cannot join a client computer to the domain.</p></li>

<li><p>You cannot connect to the Exchange server from a computer that is running Microsoft Outlook.</p></li>

<li><p>Inactive Outlook connections to the Exchange server may not be cleaned up.</p></li>

<li><p>You experience slow network performance.</p></li>

<li><p>You may experience slow network performance when you communicate with a Windows Vista-based computer.</p></li>

<li><p>You cannot create an outgoing FTP connection from the server.</p></li>

<li><p>The Dynamic Host Configuration Protocol (DHCP) server service crashes.</p></li>

<li><p>You experience slow performance when you log on to the domain.</p></li>

<li><p>Network Address Translation (NAT) clients that are located behind Windows Small Business Server 2003 or Internet Security and Acceleration (ISA) Server experience intermittent connection failures.</p></li>

<li><p>You experience intermittent RPC communications failures.</p></li>

<li><p>The server stops responding.</p></li>

<li><p>The server runs low on nonpaged pool memory</p></li>
</ul>

<p>&hellip;wow&hellip;so pretty much, this <em>Microsoft</em> technology that is turned on <em>by default</em> breaks several <em>Microsoft</em> server products and messes networking almost entirely. Nice&hellip;</p>

<p>I hope that this spares somebody some of the pain we had to go through with this.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/disclaimer/">
        Disclaimer
      </a>
    </h1>

    <span class="post-date">Sun, Mar 23, 2008</span>

    <p>The information in this blog is offered AS IS with no warranties made on the content. While information relating to configuration of computer systems posted here is generally tested on my own systems, extensive testing has not been performed. I am not responsible for any loss or damages, including loss of data, that may be occur at the use of information contained within this blog.</p>

<p>All original content on this blog is Copyright me. All rights are reserved. Linked and quoted content is Copyright of the respective Owner(s). I have no control over, nor am I responsible for, the content of any other sites, or any other products or services that may be offered through other sites.</p>

<p><em><strong>This disclaimer is effective as of January 2008.</strong></em></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/free-pdf-printer/">
        Free PDF Printer
      </a>
    </h1>

    <span class="post-date">Wed, Jan 23, 2008</span>

    <p>Every now and then somebody asks me if there is some way around paying Adobe hundreds and hundreds of dollars if they just want to create some PDF&rsquo;s. Answer? Absolutely!</p>

<p>Two free PDF printers you can use are <a href="http://www.cutepdf.com/Products/CutePDF/writer.asp">CutePDF</a> and <a href="http://sourceforge.net/projects/pdfcreator/">PDFCreator</a>. I have not used the latter, but I use CutePDF myself, have recommended CutePDF to several people, and have not had any problems with it.</p>

<p>If you are looking for a bit more functionality, such as creating a single PDF from multiple PDF&rsquo;s, rearranging pages or adding/removing pages, converting PDF&rsquo;s to MS Office documents, etc, be sure to check out <a href="http://www.nuance.com/pdfconverter/professional/">PDF Converter Pro</a> from Nuance Software. It has a whole whack of features, and it&rsquo;s only about $100.</p>

<p>I&rsquo;m not anti-Adobe or anything, but I just think that there are tonnes of less tech-savvy people out there paying hundreds of dollars for Adobe Acrobat functionality that they will never need.</p>

<p>Happy printing!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/exchange-2007-mailbox-guid/">
        Exchange 2007 Mailbox GUID 
      </a>
    </h1>

    <span class="post-date">Wed, Jan 23, 2008</span>

    <p>On a recent Exchange 2003 to 2007 upgrade, I ran into a very frustrating issue that significantly delayed our deployment. All new mailboxes that were created on using Exchange 2007 tools (Exchange 2007 Management Console or Powershell) were missing several crucial ADSI attributes, namely:</p>

<ul>
<li><p>legacyExchangeDN</p></li>

<li><p>msExchALObjectVersion</p></li>

<li><p>msExchMailboxGuid</p></li>

<li><p>msExchMailboxSecurityDescriptor (set to &ldquo;not set&rdquo;, all other accounts have a blank value here)</p></li>

<li><p>msExchUserAccountControl</p></li>
</ul>

<p><!-- more -->Of these, the most important seem to be msExchMailboxGuid and msExchMailboxSecurityDescriptor. Without msExchMailboxGuid set, the user account effectively does not have a mailbox. We were desperate enough at one point to create a random mailbox GUID (ensuring first that it is not present anywhere else in the Exchange organization), but the msExchMailboxSecurityDescriptor not being set still ensured that the mailbox was inaccessible.</p>

<p>After a few hours on the phone with MS support, and apparently some contact with a member of the Exchange 2007 development team, we were informed that this was due to a problem with the Exchange System Attendant and something to do with logs&hellip;to be honest I was not able to completely understand the guy at this point.</p>

<p>Anyhow, the temporary solution was to restart the System Attendant service on the mailbox server that is experiencing the problem. This is easy enough with Powershell (Restart-Service MSExchangeSA), but we ended up making use of the PsTools suite&rsquo;s psservice because we had multiple mailbox servers going and we needed to sometimes restart the service on a remote mailbox server. Fortunately, restarting the System Attendant service in Exchange 2007 does not restart the Information Store, as was the case with Exchange 2003. After this, the proper attributes will again be stamped and user mailbox provisioning should be successful.</p>

<p>The bug was apparently set to be resolved in SP1 for Exchange 2007 (released late last year), but I have not confirmed this.</p>

<p>Check out these links for more info:</p>

<p><a href="http://episteme.arstechnica.com/eve/forums?a=tpc&amp;s=50009562&amp;f=12009443&amp;m=362006418831&amp;r=606003038831#606003038831">Arstechnica Forum Thread</a>
<a href="http://forums.msexchange.org/m_1800455217/mpage_1/key_/tm.htm#1800455222">MSExchange Forums Thread
</a><a href="http://forums.microsoft.com/TechNet/ShowPost.aspx?PostID=2020465&amp;SiteID=17&amp;pageid=0">Microsoft Forums (I)</a>
<a href="http://forums.microsoft.com/technet/ShowPost.aspx?postid=2343802&amp;siteid=17">Microsoft Forums (II)</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/resize-vhd-files/">
        Resize VHD Files
      </a>
    </h1>

    <span class="post-date">Wed, Jan 23, 2008</span>

    <p>This topic has been covered a bit (<a href="http://blogs.msdn.com/chrisfie/archive/2007/04/19/vhdresizer-a-great-tool-for-resizing-vhd-files.aspx">here</a>, <a href="http://blogs.msdn.com/virtual_pc_guy/archive/2007/03/12/vhd-resizer-resize-and-convert-your-virtual-hard-disks.aspx">here</a>, and <a href="http://autosponge.spaces.live.com/blog/cns!D7F85948C20F0293!247.entry">here</a>, for instance) but I have been working on a project that utilizes Virtual Server for testing, and it came up again. A consultant that was working on the VM&rsquo;s in question apparently struggled for quite some time before he asked for help on it. So, I thought I would see if another post on this might help someone out.</p>

<p>If you run into a situation where you have existing Microsoft Virtual Server/PC VHD files, but the sizes you created them with initially simply don&rsquo;t cut it anymore, there is hope!</p>

<p>What you will need:</p>

<ul>
<li><p>Original VHD file (obviously)</p></li>

<li><p><a href="http://vmtoolkit.com/files/folders/converters/entry87.aspx">VhdResize</a> from <a href="http://www.vmtoolkit.com">vmtoolkit</a></p></li>

<li><p>Spare disk space</p></li>

<li><p>.Net 2.0 installed on the machine you will be using for the process</p></li>
</ul>

<p>The beauty of the tool is that it can be without having to be installed (self-contained). Just extract the zip, double-click the VhdResize.exe executable, select your source file and destination VHD, and away you go! The VhdResize also allows you to convert from fixed-size VHD&rsquo;s to dynamically-expanding VHD&rsquo;s as well, and it is non-destructive on your source VHD.</p>

<p>Note that this only increases the size of the VHD, so that, effectively, your VM will see a larger physical hard disk present; it does not resize partitions on that drive. For that, you can either use Disk Management or diskpart in your guest VM, or mount the VHD using the <em>vhdmount</em> utility included in Virtual Server and use those disk utilities from your host OS (quick walkthrough <a href="http://autosponge.spaces.live.com/blog/cns!D7F85948C20F0293!247.entry">here</a>).</p>

<p>Let me know if that&rsquo;s of use!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/reliable-free-p2v-solution/">
        Reliable, Free P2V Solution
      </a>
    </h1>

    <span class="post-date">Mon, Jan 21, 2008</span>

    <p>If you have ever had to take on a Physical-to-Virtual (P2V) migration of a server or other machine, you know that you generally have a fine balance of the following triangle of factors: cost, complexity, and reliability. It seems like the only way to get an easy and reliable solution is to throw gobs of money at either a <a href="http://www.vmware.com">VMWare</a> infrastructure or something like <a href="http://www.platespin.com/">Platespin</a>. Don&rsquo;t get me wrong: from what I&rsquo;ve heard they both offer excellent solutions in that field, but it simply isn&rsquo;t cheap. I had to find out the hard way, but there is another way.</p>

<!-- more -->

<p>The problem I was facing was that within my first month at a new job (still working there; awesome shop), I was tasked with a P2V conversion on a server, with no virtualization infrastructure in place in the organization. Since we were new to virtualization at the time and were just dabbling to start, keeping costs low (or non-existent) would also be a plus. I had to research and present a solution, figure out how it works, and get it done. We are very much a Microsoft shop, and the preference was for a Microsoft solution; so, Virtual Server it is. No problem there, as VS is free and so helped on the cost side. Now that we had the virtualization platform figured out, we just needed some way to get it from the physical box into virtual hard drives (VHD&rsquo;s) with the whole thing still operational at the end. Here&rsquo;s where the problems began.</p>

<p>Now, this was late 2006, and even in the last year virtualization has come a long way. Doing a little digging, however, I found out that Microsoft had actually released a free P2V too called the Virtual Server Migration Toolkit (VSMT). Naive as I was, I was excited that I had found an all-Microsoft solution that was still free and so fit the bill for the project. So&hellip;remember that triangle of cost/complexity/reliability that I was talking about? While VSMT is low on the cost, it cranks the complexity factor WAY up! I also discovered that the reliability portion was not really all there. If any of you have had the traumatic experience of working with VSMT, you&rsquo;ll know what I&rsquo;m talking about. For those fortunate souls unacquainted with it, here&rsquo;s a brief glimpse into VSMT:</p>

<p>It requires Microsoft Automated Deployment Services (ADS), which is basically an MS solution for deploying Server 2003 to bare metal servers over the wire; fair enough. ADS in turn requires Windows Server 2003 Enterprise Edition and DHCP with a PXE environment. The gist is that the source machine (the machine you are trying to perform the P2V on) boots with a PXE image sent out by the ADS server. This puts the machine into a state where the ADS server controls it. At this point VSMT enters the picture. You then have to design what is best described as a workflow of various VBS and XML-based scripts that prepare the machine for cloning to an image, capture data from the machines hard disks to an image on the ADS server, again run some scripts against the image to take care of things like making the HAL and kernel generic, and then create a Virtual Server configuration file (.vmc) for the whole setup. Granted I was new to this game at that point, but I spent the better part 2 weeks on this project, with various failures ranging from the initial capture phase, blue screens on my ADS server, having to manually find/replace variables in scripts because they weren&rsquo;t expanding properly, among other things, and all with virtually zero support available either from MS sites or from the community at large (as no one was apparently crazy enough to try to use the thing). I later attended a Technet conference on Microsoft&rsquo;s virtualization solutions in Vancouver. When I mentioned to one of the presenters in a Q&amp;A section that I had successfully completed a P2V using VSMT, he expressed actual surprise at the fact that someone got the whole thing to work! A few months later, the VM started logging disk errors and failed to back up successfully, and we ended up scrapping the VM and building a new one from scratch. Like I said, low cost but high complexity and low reliability.</p>

<p>So, when I heard that Microsoft was releasing a Beta of Systems Center Virtual Machine Manager (SCVMM, although it was just VMM at that point), I jumped at the chance to try this thing out. Point and click P2V? Sign me up! I later discovered that Beta1 did _not _yet include P2V functionality, so my hopes at a simple P2V solution faded again. These days, of course, you can get yourself a copy of the full version <a href="http://www.microsoft.com/systemcenter/scvmm/default.mspx">System Center Virtual Machine Manager</a> for around $500 US, but unfortunately that still does not completely satisfy my &ldquo;cheap-to-free&rdquo; preference.</p>

<p>When the next P2V project rolled around, I was desperate to find something, <em>anything</em> that would avoid the VSMT debacle. I even started looking outside of the Microsoft camp to anything that could get our physical box running as a VM, and lo, I was rewarded! Enter <a href="http://www.vmware.com/products/converter/">VMWare Converter</a>.  VMWare had been kind enough to release a simple, free P2V utility that can run on pretty much any version of Windows, including client OS&rsquo;s like XP, and was a simple wizard-driven point-and-click process without all the infrastructure requirements. Beautiful! Unfortunately this did not get us to a Virtual Server machine. But, wait! There&rsquo;s hope! A simple, self-contained utility called <a href="http://vmtoolkit.com/files/folders/converters/entry8.aspx">VMDK2VHD</a> was released by <a href="http://vmtoolkit.com/">vmToolkit</a>. This beauty of a tool allows you to convert your VMWare VMDK-format virtual hard drives into MS Virtual Server/PC VHD files. I was set!</p>

<p>The overall process was even pretty painless. Of course it can take a few hours for the whole process if you&rsquo;re converting machines with a whole bunch of data, but trust me, it&rsquo;s a breeze compared to some of the other options out there.</p>

<p>So, here&rsquo;s what you need:</p>

<ul>
<li><p>Source physical machine</p></li>

<li><p>I recommend having a conversion tools machine to install all the required software onto and to do all the grunt work of the actual conversions.</p></li>

<li><p>VMWare Converter installed (probably on your conversion tools machine)</p></li>

<li><p>Access to enough disk to store both the VMWare VMDK hard disk files and the Virtual Server/PC VHD hard disk files</p></li>

<li><p>VMWare Server installed (probably on your conversion tools machine).</p></li>

<li><p>PrepVM.vbs script (more on that later)</p></li>

<li><p>Generic hal.dll or ntoskrnl.exe, either from your Windows setup CD or from %windir%\system32\servicepackfiles if you have applied a service pack at any time.</p></li>

<li><p>VMDK2VHD extracted somewhere (probably on your conversion tools machine). Note that this utility is self-contained and does not need to be installed, just run.</p></li>

<li><p>Virtual Server or Virtual PC installed somewhere to test the final product.</p></li>
</ul>

<p>If you have all that, you are ready to go:</p>

<blockquote></blockquote>

<ol>
<li><p>Ensure that the source physical machine is running, and that you have network connectivity to it from your conversion tools machine.</p></li>

<li><p>Launch the VMWare Converter application on your conversion tools machine.</p></li>

<li><p>Click <strong>Import Machine</strong> and follow the wizard to set the options for your conversion. A few notes: (1) VMWare Converter will install an agent on the source physical machine, and will ask you for administrative credentials to connect to the machine. (2) When selecting the partitions to convert, be sure to un-check utility partitions as are found on many servers. VMWare Converter will not understand these partitions, and the conversion will fail. (3) It is best to output your data to a single VMDK file and not to use the VMWare option of splitting the hard disk into multiple 2 GB files. Virtual Server does not use a similar technique, and the VMDK2VHD tool will not understand it as far as I recall. (4) Be sure to select the correct output format for your file. If you are running a different version of VMWare from the version that VMWare Converter is creating, you will <em>not</em> be able to start your VMWare virtual machine and complete the conversion process.</p></li>

<li><p>Start the conversion, and then go for lunch&hellip;this process can take a while, as it is reading all of your source data, converting it into a VMDK format, and writing it to the destination VMDK file<strong>.</strong></p></li>

<li><p>When the conversion completes, I recommend making a backup copy of the VMDK files and working with those from now on. If things blow up, you can roll back to the VMDK files rather than having to re-do the whole capture process.</p></li>

<li><p>Configure a new virtual machine in VMWare Server to use the VMDK file created and start it up. I recommend leaving the network cards disconnected and logging on locally, as this will avoid problems such as IP address and naming conflicts that come with having both the physical machine and its virtual counterpart on the same LAN.</p></li>

<li><p>Log on to the VMWare virtual machine. NOTE: Cancel all of the &ldquo;New Hardware Found&rdquo; wizards that pop up. These are all for VMWare virtual devices, and we will be getting rid of these anyway. Installing them is just a waste of time and might mess with the whole process.</p></li>

<li><p>CAUTION BEFORE PROCEEDING: You will be replacing the hal.dll and ntoskrnl.exe files in %windir%\system32. I recommend making backup copies of the hal.dll and ntoskrnl.exe files at %windir%\system32. You don&rsquo;t have to do this, but I prefer to err on the side of caution. ALSO: The replacement files MUST be of the same service pack level as your current machine. If the SP levels don&rsquo;t match, your machine is <em>very</em> likely to give you hassles and might not even start. That being said&hellip;</p></li>

<li><p>Make the VM generic by copying the generic hal.dll and ntoskrnl.exe files from either your Windows setup disk or from the %windir%\system32\servicepackfiles directory. If you are using the service pack files, you can simply copy the files into the VM&rsquo;s %windir%\system32 folder. If you are using the Windows setup disk, you will need to run the following commands on the server (assuming that your CD drive on the machine is D:): <code>expand d:\i386\hal.dl_ %windir%\system32\\hal.dll</code> and <code>expand d:\i386\\ntoskrnl.ex_ %windir%\system32\ntoskrnl.exe</code>.</p></li>

<li><p>Uninstall VMWare Tools if it has been installed.</p></li>

<li><p>Run the Prepvm.vbs script included at the end of this page. The script disables the VMWare devices in the machine so that they are not present when the machine starts up in Virtual Server/PC. It will also shut down the VM for the final conversion process when it&rsquo;s done running.</p></li>

<li><p>At this point, you could make more backup copies of the VMDK files, but, to be honest, the &ldquo;make the machine generic&rdquo; steps are fairly quick, and will take much less time to re-do than to copy gigs and gigs of VMDK files as backups.</p></li>

<li><p>Launch the VMDK2VHD utility on your conversion tools machine. The interface is very simple, and basically just asks you for the source VMDK file and the destination VHD file that you want to output it to. It also does ask you if you want a fixed or dynamically-expanding VHD file. This is totally up to you. Basically, think of it this way: If your VHD represents an 80 GB hard disk, but you only have 10 GB of data on it, a fixed-size disk will be 80 GB in size, whereas a dynamically-expanding VHD will be 10 GB in size and will grow as the size of the data on your VHD grows.</p></li>

<li><p>Let the utility run, and go and grab a coffee/dinner/breakfast/whatever, because this will again take a fair bit of time, depending on the amount of data you&rsquo;re working with.</p></li>

<li><p>When the conversion is done, configure a new VM in Virtual Server/PC that uses the VHD file produced by VMDK2VHD as your virtual hard disk.</p></li>

<li><p>Start up the Virtual Server/PC VM, again probably with NIC&rsquo;s disconnected to avoid IP/Naming conflicts.</p></li>

<li><p>Logon to the machine and install all of the hardware that Windows finds.</p></li>

<li><p>If everything seems in order, celebrate! Shut down your source physical machine, connect the VM to the network, and away you go!</p></li>
</ol>

<blockquote>

> 
> 
</blockquote>

<p>Again, this post would not be possible without other smarter people having gone before me. Some resources:</p>

<p><a href="http://searchservervirtualization.techtarget.com/tip/0,289483,sid94_gci1225164,00.html?asrc=SS_CLA_303373&amp;psrc=CLT_94">How to convert VMware virtual disk images to Virtual Server</a></p>

<p><a href="http://www.i-worx.ca/download/public/prepvm.vbs">Prepvm.vbs</a> script</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/modifying-group-memberships-with-powershell-part-2/">
        Modifying Group Memberships with Powershell, Part II
      </a>
    </h1>

    <span class="post-date">Sat, Jan 19, 2008</span>

    <p>I had hoped to put this all in one post, but the thing would have gone on forever! Part I covered some basics in copying group memberships to an Active Directory user from another user, such as a template account, using Powershell. Part II will delve into my misadventures in gaining more control of user group memberships, including removing users from a group either by editing the group&rsquo;s attributes or editing the user&rsquo;s attributes. I was also looking for a way to change dial-in permissions on user accounts, and that will be covered by a similar strategy.</p>

<p>While these examples should be less dependent on the MS Exchange 2007 snap-in for Powershell and <a href="http://www.codeplex.com/PowerShellCX">Powershell Community Extensions</a>, please note that I have not checked through the code samples to confirm what is purely Powershell and what requires those snap-ins.</p>

<!-- more -->

<p>So in Part I we did the following to add a user to a group:</p>

<ul>
<li><p>Connected to the ADSI object for our group using <code>[adsi]&quot;LDAP://[group's distinguished name]&quot;</code> and stored as <em>$fqgroup</em>.</p></li>

<li><p>Added the user to the group using <code>$fqgroup.member.add(&quot;[user's distinguished name]&quot;)</code></p></li>

<li><p>Applied the changes user <code>$fqgroup.setinfo()</code></p></li>
</ul>

<p>The problem for me came when I tried to remove group memberships. I don&rsquo;t have a huge scripting background; I mostly dabble in batches, and PHP, and have avoided VBS whenever I can. Powershell is my first real foray into extensive automation, and I try to keep things simple where I can and use provided cmdlets, snap-ins, and wrappers. So, when I wanted to remove group memberships, I checked out what the Exchange 2007 snap-in for Powershell had to offer.</p>

<p>Wouldn&rsquo;t you know it? Exchange has some membership-manipulating options available for us:</p>

<p><code>Get-Group 'Test Group' | Get-Member | Where-Object { $_.name -match 'members' } | Format-List Name,Membertype,Definition</code></p>

<p>returns:</p>

<p><code>Name : get_Members
MemberType : Method
Definition : Microsoft.Exchange.Data.MultiValuedProperty</code>1[[Microsoft.Exchange.
Data.Directory.ADObjectId, Microsoft.Exchange.Data.Directory, Version=8.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35]] get_Members()
<code>
Name : set_Members
MemberType : Method
Definition : System.Void set_Members(MultiValuedProperty`1 value)
</code>
Name : Members
MemberType : Property
Definition : Microsoft.Exchange.Data.MultiValuedProperty<code>1[[Microsoft.Exchange.
Data.Directory.ADObjectId, Microsoft.Exchange.Data.Directory, Version=8.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35]] Members {get;set;}</code></p>

<p>The only reasons I threw in the <em>Where-Object</em> and <em>Format-List</em> cmdlets were because I didn&rsquo;t want to show every single member, and Powershell will by default output <em>Get-Member</em> to a table and cut off the <em>Definition</em> column that I&rsquo;m interested in here.</p>

<p>Now, notice that the property <em>Members** **</em>(the last one in our list) specifically states {get;set;} at the end of its definition. This tells us that we should be able to both retrieve the members property (get) and make changes to it (set). Conveniently, we also have two methods for those tasks: _get<em>Members</em> for retrieving the <em>Members</em> property and _set<em>Members</em> for making changes to it. It&rsquo;s weird, though, that the definition for _get<em>Members</em> has a whole bunch of .Net information about Exchange going on in there, while _set<em>Members</em> simply references <em>System.Void</em>, isn&rsquo;t it? It&rsquo;s also a little weird that the <em>Set-Group</em> cmdlet doesn&rsquo;t seem to have any options that reference membership (check <code>Get-Help Get-Group -detailed</code>)</p>

<p>Let&rsquo;s try it, though:</p>

<p>Using Active Directory Users and Computers (ADUC), create a new security group called <em>Powershell TestGroup</em>, and add some users to it. I will use the example of User1 and User2. Then try the following code:</p>

<p><code>$group = Get-Group 'Powershell TestGroup'
$group.Members</code></p>

<p>This should display a list of your group members showing their Rdn, Parent, Depth, DistinguishedName, DomainId, ObjectGuid, and Name properties. Good so far; let&rsquo;s try the get_Members method:</p>

<p><code>$group.get_Members()</code></p>

<p>Still good right? You get the same list. Alright, now let&rsquo;s save a new list of users that doesn&rsquo;t include User1, and then to our _set<em>Members</em> method:</p>

<p><code>$newgroupmembers = $group.get_Members() | Where-Object { $_.name -notmatch &quot;User1&quot; }</code></p>

<p>$newmembers will now include all of the group members except for User1. You can verify this by just typing <code>$newgroupmembers | Sort | Format-Table Name</code> at the console. Alright, so we have our new list of users. Remember that we didn&rsquo;t make the array $newmembers up ourselves but got the list using the get_Members() method, so we&rsquo;re free of syntax errors here. Let&rsquo;s try _set<em>Members</em> then:</p>

<p><code>$group.set_Members($newgroupmembers)</code></p>

<p>Hmm&hellip;that didn&rsquo;t go so well. All of sudden Powershell gives us a bunch of error output:</p>

<p><code>Cannot convert argument &quot;0&quot;, with value: &quot;System.Object[]&quot;, for &quot;set_Members&quot; to type &quot;Microsoft.Exchange.Data.MultiValuedProperty</code>1[Microsoft.Exchange.Data.Directory.ADObjectId]&rdquo;: &ldquo;Cannot convert value &ldquo;System.Object[]&rdquo; to type &ldquo;Microsoft.Exchange.Data.MultiValuedProperty<code>1[Microsoft.Exchange.Data.Directory.ADObjectId]&quot;. Error: &quot;Conversion from System.Management.Automation.PSObject to Microsoft.Exchange.Data.Directory.ADObjectId has not been implemented.&quot;&quot;t line:1 char:19
+ $group.set_members( &lt;&lt;&lt;&lt; $newgroupmembers)</code></p>

<p>Take note of the second to last line:</p>

<blockquote>Conversion from System.Management.Automation.PSObject to Microsoft.Exchange.Data.Directory.ADObjectId has not been implemented.</blockquote>

<p>Now, I&rsquo;m not a .Net developer and I don&rsquo;t claim to be _nearly _as intimately familiar with Powershell as some of the other guys out there (<a href="http://thepowershellguy.com/blogs/posh/">The Powershell Guy</a> for instance), but this seems to be one of those little things that the Exchange team just didn&rsquo;t get around to implementing. Maybe I&rsquo;m wrong, I don&rsquo;t know. But I do know that I needed a way around this road block.</p>

<p>So, off I went through the wild, wild web, looking for people much smarter than myself who might be able to get this thing up and running. I have to give credit to these folks, and you might be able to get more useful information from them, so I will include links to other useful articles/blogs below. Keeping right on though, here&rsquo;s what we need to do:</p>

<p><code>
$group = Get-Group &quot;Powershell TestGroup&quot;
$username = &quot;User1&quot;
$user = get-user $username
$userdn = $user.distinguishedName
$newgroupmembers = $group.members | Where-Object { $_.name -notmatch &quot;$username&quot; }
$groupdn = $group.distinguishedName
$fqgroup = [adsi]&quot;LDAP://$groupdn&quot;
$fqgroup.Member.Remove($userdn)
$fqgroup.setInfo()
</code></p>

<p>After all that searching and tests, it was actually pretty simple! Here&rsquo;s what we did:</p>

<p>I did cheat a bit (like I said, I like to keep things simple when I can) and used the Exchange <em>Get-Group</em> cmdlet for our $group variable, and I also used the Exchange <em>Get-User</em> cmdlet for our $user variable, but you could use DirectoryServices.DirectorySearcher instead as in <a href="http://janssenjones.typepad.com/janssenjonescom/2007/01/powershell_and_.html">this post</a>. I borrowed some of my info from that post as well, so credit is owed there. But I digress.</p>

<p>The <em>$newgroupmembers</em> line is similar to the one we used earlier with our _set<em>Members</em> example that failed. You can use either $group.members or $group.get_Members() interchangeably. All we&rsquo;re doing is creating an array of group members that does not contain the user that we want to remove from the group.</p>

<p>With <em>$fqgroup</em> we are again just connecting to the group using the Powershell ADSI wrapper. In the end, all that needs to be done here is to use the <em>remove()</em> method of the Member property of our <em>$fqgroup</em>. The change is then applied using <em>setinfo().</em></p>

<p>Now, remember how we found that methods weren&rsquo;t displayed through Get-Member for ADSI objects? Try this one out for size:</p>

<p><code>$fqgroup.member | Get-Member</code></p>

<p>Here we see methods available! But for <code>$fqgroup.member | Get-Member</code>? Nope, nothing! Weird&hellip;</p>

<p>You should also theoretically be able to modify the user account directly and change the <em>memberOf</em> attribute, but I have had some difficulty with this. I will update the post if I figure out what the problem was there.</p>

<p>Anyway, there you have it. I owe a tremendous amount of thanks to several other IT bloggers for being able to post this:</p>

<p><a href="http://blogs.technet.com/benp/archive/2007/03/05/benp-s-basic-guide-to-managing-active-directory-objects-with-powershell.aspx">Benp’s Basic Guide to Managing Active Directory Objects with PowerShell</a>
<a href="http://www.viveksharma.com/techlog/2006/10/22/how-to-get-dl-membership-in-exchange-2007/">How to get DL membership in Exchange 2007
</a><a href="http://www.leadfollowmove.com/archives/powershell/managing-group-membership-in-active-directory-with-powershell-part-1">Managing group membership in Active Directory with PowerShell (Part 1)
</a><a href="http://www.leadfollowmove.com/archives/powershell/managing-group-membership-in-active-directory-with-powershell-part-2">Managing group membership in Active Directory with PowerShell (Part 2)</a>
<a href="http://janssenjones.typepad.com/janssenjonescom/2007/01/powershell_and_.html">Powershell and ActiveDirectory - Modify-Group-Membership
</a><a href="http://richardsiddaway.spaces.live.com/blog/cns!43CFA46A74CF3E96!241.entry">PowerShell script to list user group membership in Active Directory
Accessing AD with PowerShell</a></p>

<p>Bitcoin tip address for this post: 1DMybxZn2eUfKndJsn56Xq7BUoZSFvFfeb</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/modifying-group-memberships-with-powershell-part-1/">
        Modifying Group Memberships with Powershell, Part I
      </a>
    </h1>

    <span class="post-date">Sat, Jan 19, 2008</span>

    

<p>I recently had to spend <em>hours</em> figuring out how to properly modify Active Directory group memberships using Powershell. Some of the .Net methods have not yet been implemented, so I had to get a bit tricky with it. I could find the various bits of information I needed in various places, so I hope that collecting them here in one place is of some use to others.</p>

<p>The scenario was that I needed to disable user accounts in a Windows Server 2003 Active Directory environment running with Exchange 2007. We have a fairly customized, hosted Exchange environment, and so disabling a user is not just a simple matter and right-clicking and disabling the account in Active Directory Users and Computers (ADUC); we have a 2-page doc for the process to catch everything from removing group memberships to setting up email forwarding or restrictions, changing dial-in permissions, changing NTFS permissions on profile directories, etc.</p>

<!-- more -->

<p>Anyway, I had already dabbled in modifying group memberships in our user creation script (still a bit clunky, but it gets the job done) by copying group memberships from a template account. It goes something like this (please note that several of these commands require the Exchange 2007 snap-in for Powershell, and some also the <a href="http://www.codeplex.com/PowerShellCX">Powershell Community Extensions</a>  snap-in):</p>

<p><code>
$templaccn = Get-Mailbox | Where-Object { $_.name -match [template account name] }
$newuser = Get-User [new user name]
$filterid = ( Get-User $templaccn.name ).identity
$groups = Get-Group -filter { Members -eq $filterid }
$groups | Foreach-Object {
$groupdn = $_.DistinguishedName
</code><code>$fqgroup = [ADSI](&quot;LDAP://$groupdn&quot;)
</code><code>$membercheck = ($fqgroup.member | Where-Object { $_ -eq $newuser})
</code><code>if ( $membercheck.length -ge 1)
</code><code>{
</code><code>Write-Host &quot;User is already a member of&quot; $_.name &quot;</code>b. No group addition made. <code>n&quot;
</code><code>}
</code><code>else
</code><code>{
</code><code>$fqgroup.member.add(&quot;$newuserdn&quot;)
</code><code>$fqgroup.setinfo()
</code><code>}</code>
<code>}</code></p>

<p>So here&rsquo;s the run down:</p>

<p>The opening <em>Get-Mailbox</em> line uses one of the Exchange 2007 snap-ins to get the mailbox object for our template account and saves it to the <em>$templaccn</em> variable; substitute <code>[template account name]</code> with the name of your template account. I also set the <em>$newuser</em> variable to the name of the user who&rsquo;s group membership we will be modifying. This is just because the script is used for user creation, so you might want to change the variable name to something like <em>$user</em> or <em>$moduser</em>; just be sure to change the variable throughout your code!</p>

<p>The next two lines are used in conjunction with each other to find all groups of which the template account is a member. You could also replace these two lines with <code>Get-Group | Where-Object { $_.Members -match $templaccn }</code>, but that first collects <em>ALL</em> the groups in your environment and then runs them through a filter of <code>Where-Object</code>. I have found the filterid way to be much quicker.</p>

<p>For each group, we then first save the distinguished name to the _$groupdn _variable, then use the Powershell ADSI wrapper to store its full ADSI object as <em>$fqgroup</em>. I usually prefix <em>fq</em> to variables for full ADSI objecs to denote their type, but you can obviously use something like _adObj** **_whatever convention you like. The <em>member</em> property for the group is a multi-valued property that contains the groups members, so using <em>Where-Object</em> we effectively set a value to <em>$membercheck</em> only if our user is a member of that group. As I was using this to create new users, this was probably not completely necessary, but it was good practice anyway.</p>

<p>The <em>if</em> statement there just throws out that the user is already a member of the group if <em>$membercheck</em> had any value set, otherwise it proceeds to adding the user to the group.</p>

<p>We then use the <em>add()</em>  method of the member property of the ADSI object for our group, supplying our user&rsquo;s distinguished name as an argument, and use <em>setInfo()</em> to apply the changes to the ADSI object.</p>

<p>Now, the reason this was tough to do in the first place, and why I ended up later having so much trouble with removing group memberships and making other modifications, is because the <em>$fqgroup</em> ADSI object does not display any methods! You can read all the properties you want, but for some reason the Powershell design team thought it would be a good idea to hide the methods, even though they are there. If you don&rsquo;t believe me, try this:</p>

<p><code>$domroot = [adsi]''</code>
`</p>

<h2 id="distinguishedname">distinguishedName</h2>

<p>{DC=i-worx,DC=ca}
`</p>

<p>Try just typing <em>$domroot</em>. It should return something like:
<code>
[PS] C:\&gt;$domroot</code></p>

<h2 id="distinguishedname-1">`distinguishedName</h2>

<p>{DC=test,DC=local}`</p>

<p>Alright, now try using Get-Member to get some info on this ADSI object: <code>$domroot | Get-Member</code></p>

<p>All of those seem to be Properties, right, with no methods? Hmm&hellip; For more info on this, check out <a href="http://blogs.technet.com/benp/archive/2007/03/05/benp-s-basic-guide-to-managing-active-directory-objects-with-powershell.aspx">Benp’s Basic Guide to Managing Active Directory Objects with PowerShell</a> as well as <a href="http://pathologicalscripter.wordpress.com/2006/09/28/invisible-methods-for-adsi/">&ldquo;Invisible&rdquo; methods for ADSI?</a> from the Pathological Scripter.</p>

<p>Anyway, all this to show that it doesn&rsquo;t seem to be as straightforward as we might have hoped.</p>

<p>So, that seems to have covered <em>adding</em> users to groups&hellip;now what if I want to <em>remove</em> a user&rsquo;s group memberships? Part II of this post will cover that&hellip;</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/about/">
        About
      </a>
    </h1>

    <span class="post-date">Sat, Jan 19, 2008</span>

    <p>I&rsquo;ve been working with technology since about 2006, first in systems
administration and then moving onto network operations &amp; engineering.  Like a
lot of other techies out there, I spend a lot of my time learning about new
technologies out there, either for the fun of it or because I just need to make
the damned thing work!</p>

<p>Anyway, when I come across some little tidbit of information that&rsquo;s worth
sharing, you&rsquo;re sure to find it in here&hellip;as of now of course&hellip;what? Did you
think I was going to delve back through years and years of web history, forums,
blogs, white papers and KB&rsquo;s to toss them all in here? Well&hellip;maybe&hellip;we&rsquo;ll see
about that. For now, feel free to visit as often as you want.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/ultimate-guide-to-linux-boot-problems/">
        Ultimate Guide to Linux Boot Problems
      </a>
    </h1>

    <span class="post-date">Wed, Jan 16, 2008</span>

    <p>I haven&rsquo;t played around much in Linux lately, but I finally dusted off my <a href="http://www.ubuntu.com/">Ubuntu</a> CD&rsquo;s and started tooling around again. I already had Vista installation on my work laptop, and did not want to blow that away, so I erred on the side of caution by not letting the Xubuntu setup program install its own GRUB bootloader&hellip;except then I couldn&rsquo;t get into the Linux OS&hellip;</p>

<p>So, off I go in search of GRUB install guides, and just about every how-to out there is using the basic scenario that GRUB was installed in the first place, and that it just needs to reinstall itself, which was totally not the case this time around!</p>

<p>Anyway, after searching and searching and booting back and forth multiple times between Vista (slow boot!) and the Xubuntu live CD (which is somehow booting faster, even though it&rsquo;s discovering all of the hardware for the first time), I finally stumbled across an absolute gem for Linux booting troubleshooting.</p>

<p>I have to say this is by <em>FAR</em> the most conclusive coverage I have EVER seen for resolving Linux boot issues. Lilo and GRUB issues are covered with tonnes of different scenarios, including dual-booting and the dreaded Vista BCD bootloader. If you have run just about ANY Linux distro, you need this reference. And don&rsquo;t tell me that you&rsquo;ve never had boot loader issues, &lsquo;cuz it will happen to you!</p>

<p>Check it out <a href="http://www.justlinux.com/forum/showthread.php?s=7b4f3007a3173da87ba7e5683965a271&amp;t=144294">here</a>.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/update-on-network-solutions-frontrunning/">
        Update on Network Solutions Front-running
      </a>
    </h1>

    <span class="post-date">Sat, Jan 12, 2008</span>

    <p>If you caught my previous post about Network Solutions&rsquo; practice of domain front-running, here&rsquo;s the latest bit: They are now actually claiming that this practice protects people <strong><em>against</em></strong> front-running (see <a href="http://www.computerworld.com/action/article.do?command=viewArticleBasic&amp;articleId=9056778">CW article</a> for more details). Their logic? Well, if the domain gets reserved when you search for it, they are preventing scammers from registering the domain and selling it back to you&hellip;</p>

<p>&hellip;uhm&hellip;</p>

<p>Let&rsquo;s try this again:</p>

<ul>
<li><p>I go to NS to search for a domain&rsquo;s availability</p></li>

<li><p>NS registers that domain so that it&rsquo;s only available through them, but in no way is this reservation tied to me, the person who did the search.</p></li>
</ul>

<p>End results:</p>

<ul>
<li><p>If I want the domain, I <em>HAVE</em> to buy it through Network Solutions.</p></li>

<li><p>If some scammer wants to snatch up the domain to sell it back to me at a profit, the only catch is that he has to register the domain through Network Solutions. He can do this because, again, NS has in NO WAY tied the search and subsequent reservation to only myself.</p></li>
</ul>

<p>Wow, even for PR spin that&rsquo;s some pretty crappy logic in their excuse.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="https://bamboo.slabnet.com/~hslabbert/blog/post/network-solutions-domain-frontrunning/">
        Network Solutions Domain Frontrunning
      </a>
    </h1>

    <span class="post-date">Wed, Jan 9, 2008</span>

    <p>If you have not heard of the term cybersquatting, here&rsquo;s the gist:</p>

<ul>
<li><p>Think of a domain name that someone else is likely to be interested in.</p></li>

<li><p>Register/Purchase that domain.</p></li>

<li><p>Wait for that person to try and register the domain for themselves.</p></li>

<li><p>Sell the domain to them for a profit.</p></li>
</ul>

<p>Another spin on this idea is called domain frontrunning, where domain registrars track which domains are checked for availability (e.g. you searched for a domain that you&rsquo;re interested in), and they snatch up that domain. They still show the domain as available through their searches, but other whois lookups or domain registrar searches shows the domain as already registered&hellip;to the first registrar.This might sound confusing, but basically it means that whatever domain you just searched for through the first registrar is now <em>ONLY</em> available through that registrar, forcing you to buy it through them and no one else. Technically, this is not illegal, but it&rsquo;s a pretty underhanded way to do business. While I personally have never had any problems working with <a href="http://www.networksolutions.com/">Network Solutions</a>, they are currently accused of this practice of front running.</p>

<p>For more details, check out the full article at <a href="http://www.domainnamenews.com/featured/domain-registrar-network-solutions-front-running-on-whois-searches/1359">Domain Name News</a>.</p>

  </div>
  
</div>
</div>

  </body>
</html>
